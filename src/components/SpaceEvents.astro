---
/**
 * SpaceEvents Component
 * Displays events filtered by keywords for a specific space
 */

import Icon from "@components/Icon.astro";
import {
    programmeEvents,
    formatDate,
    isPastEvent,
    sortEvents,
    type Event,
} from "@data/eventCollections";

interface Props {
    keywords: string[];
    spaceName: string;
}

const { keywords, spaceName } = Astro.props;

// Filter events by matching keywords against title and description
function filterEventsByKeywords(events: Event[], keywords: string[]): Event[] {
    if (!keywords || keywords.length === 0) {
        return [];
    }

    const normalizedKeywords = keywords.map((k) => k.toLowerCase().trim());

    return events.filter((event) => {
        const title = event.name?.text?.toLowerCase() || "";
        const description =
            event.description?.text?.toLowerCase() ||
            event.summary?.toLowerCase() ||
            "";
        const searchText = `${title} ${description}`;

        return normalizedKeywords.some((keyword) =>
            searchText.includes(keyword),
        );
    });
}

// Get filtered and sorted events
const filteredEvents = filterEventsByKeywords(programmeEvents, keywords);
const upcomingEvents = sortEvents(
    filteredEvents.filter((e) => !isPastEvent(e)),
);
const hasEvents = upcomingEvents.length > 0;
---

{
    hasEvents && (
        <section class="mt-12">
            <div class="flex items-center gap-3 mb-6">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-500/20 ring-1 ring-amber-500/30">
                    <Icon
                        name="calendar-days"
                        style="solid"
                        class="h-5 w-5 text-amber-300"
                    />
                </div>
                <h2 class="text-2xl font-bold text-violet-100">
                    Upcoming Events
                </h2>
            </div>

            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                {upcomingEvents.map((event) => (
                    <a
                        href={event.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="group flex flex-col rounded-2xl bg-violet-900/40 ring-1 ring-violet-700/50 hover:ring-amber-500/50 p-5 transition-all duration-300 hover:shadow-lg hover:shadow-amber-500/10"
                    >
                        <div class="flex items-start justify-between gap-3 mb-3">
                            <span class="inline-flex items-center gap-1.5 rounded-full bg-amber-500/20 px-3 py-1 text-xs font-medium text-amber-200 ring-1 ring-amber-500/30">
                                <Icon
                                    name="calendar-check"
                                    style="solid"
                                    class="h-3 w-3"
                                />
                                Upcoming
                            </span>
                            <Icon
                                name="arrow-up-right-from-square"
                                style="solid"
                                class="h-4 w-4 text-violet-400 group-hover:text-amber-300 transition-colors"
                            />
                        </div>

                        <h3 class="text-base font-semibold text-violet-100 group-hover:text-white line-clamp-2 mb-2">
                            {event.name.text}
                        </h3>

                        <div class="mt-auto pt-3 border-t border-violet-700/30">
                            <div class="flex items-center gap-2 text-sm text-violet-300">
                                <Icon
                                    name="clock"
                                    style="regular"
                                    class="h-4 w-4 text-violet-400"
                                />
                                <span>{formatDate(event.start.local)}</span>
                            </div>
                            {event.online_event && (
                                <div class="flex items-center gap-2 text-sm text-violet-300 mt-1">
                                    <Icon
                                        name="laptop"
                                        style="solid"
                                        class="h-4 w-4 text-violet-400"
                                    />
                                    <span>Online Event</span>
                                </div>
                            )}
                        </div>
                    </a>
                ))}
            </div>

            <div class="mt-4 text-center">
                <a
                    href="https://www.eventbrite.com/o/unltd-3046207224"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 text-sm text-violet-400 hover:text-amber-300 transition-colors"
                >
                    View all events on Eventbrite
                    <Icon
                        name="arrow-up-right-from-square"
                        style="solid"
                        class="h-3 w-3"
                    />
                </a>
            </div>
        </section>
    )
}

{
    !hasEvents && keywords && keywords.length > 0 && (
        <section class="mt-12">
            <div class="flex items-center gap-3 mb-6">
                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-violet-500/20 ring-1 ring-violet-500/30">
                    <Icon
                        name="calendar-days"
                        style="solid"
                        class="h-5 w-5 text-violet-300"
                    />
                </div>
                <h2 class="text-2xl font-bold text-violet-100">Events</h2>
            </div>

            <div class="rounded-2xl bg-violet-900/30 ring-1 ring-violet-700/50 p-8 text-center">
                <Icon
                    name="calendar-check"
                    style="solid"
                    class="h-12 w-12 text-violet-500 mx-auto mb-4"
                />
                <p class="text-violet-300 mb-4">
                    No upcoming events scheduled for this space right now.
                </p>
                <a
                    href="https://www.eventbrite.com/o/unltd-3046207224"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 text-sm text-violet-400 hover:text-amber-300 transition-colors"
                >
                    Check all UnLtd events on Eventbrite
                    <Icon
                        name="arrow-up-right-from-square"
                        style="solid"
                        class="h-3 w-3"
                    />
                </a>
            </div>
        </section>
    )
}
