---
import DynamicIcon from "@components/DynamicIcon.astro";
import Icon from "@components/Icon.astro";

interface Programme {
    icon: string;
    name: string;
    path: string;
    colour?: "amber" | "purple" | string;
    description?: string;
}

interface ProgrammeService {
    name: string;
    icon: string;
    included?: boolean;
}

type GrantUsability = Record<string, boolean>;

interface AwardProps {
    name: string;
    description: string;
    grant: number;
    programme: Programme;
    grantUsability: GrantUsability;
    programmeServices: ProgrammeService[];
}

const {
    name,
    description,
    grant,
    programme,
    grantUsability,
    programmeServices,
} = Astro.props as AwardProps;

// Theme tokens for programme colours on different card backgrounds
const colourThemes = {
    // Amber on light background (Starting Up cards)
    "amber-light": {
        badgeBg: "bg-amber-100 dark:bg-amber-100",
        badgeText: "text-amber-800 dark:text-amber-800",
        badgeRing: "ring-1 ring-amber-600/20 dark:ring-amber-600/20",
        serviceItemText: "text-amber-700 dark:text-amber-700",
        descriptionText: "text-amber-700/80 dark:text-amber-700/80",
        hoverBg: "hover:bg-amber-50 dark:hover:bg-amber-50",
    },
    // Amber on dark background (Scaling Up cards)
    "amber-dark": {
        badgeBg: "bg-amber-500/20 dark:bg-amber-500/20",
        badgeText: "text-amber-400 dark:text-amber-400",
        badgeRing: "ring-1 ring-amber-400/30 dark:ring-amber-400/30",
        serviceItemText: "text-amber-400 dark:text-amber-400",
        descriptionText: "text-amber-400/80 dark:text-amber-400/80",
        hoverBg: "hover:bg-amber-500/10 dark:hover:bg-amber-500/10",
    },
    // Purple on light background (Starting Up cards)
    "purple-light": {
        badgeBg: "bg-purple-100 dark:bg-purple-100",
        badgeText: "text-purple-800 dark:text-purple-800",
        badgeRing: "ring-1 ring-purple-600/20 dark:ring-purple-600/20",
        serviceItemText: "text-purple-700 dark:text-purple-700",
        descriptionText: "text-purple-700/80 dark:text-purple-700/80",
        hoverBg: "hover:bg-purple-50 dark:hover:bg-purple-50",
    },
    // Purple on dark background (Scaling Up cards)
    "purple-dark": {
        badgeBg: "bg-purple-500/20 dark:bg-purple-500/20",
        badgeText: "text-purple-300 dark:text-purple-300",
        badgeRing: "ring-1 ring-purple-400/30 dark:ring-purple-400/30",
        serviceItemText: "text-purple-300 dark:text-purple-300",
        descriptionText: "text-purple-300/80 dark:text-purple-300/80",
        hoverBg: "hover:bg-purple-500/10 dark:hover:bg-purple-500/10",
    },
} as const;

// Determine if this is a Starting Up award (lighter) or Scaling Up award (darker)
const isStartingUp = name.toLowerCase().includes("starting up");

// Select the appropriate theme based on programme colour and card background
const themeKey =
    `${programme?.colour ?? "amber"}-${isStartingUp ? "light" : "dark"}` as keyof typeof colourThemes;
const theme = colourThemes[themeKey] ?? colourThemes["amber-light"];

const grantFormatted = new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: 0,
}).format(grant ?? 0);

const grantUsabilityEntries = Object.entries(grantUsability ?? {});
const services = programmeServices ?? [];

// Card background and text classes based on award type
// Starting Up: Light background for early-stage ventures
// Scaling Up: Dark background for established ventures
const cardBg = isStartingUp
    ? "bg-white dark:bg-white"
    : "bg-slate-900 dark:bg-slate-900";
const cardRing = isStartingUp ? "ring-1 ring-black/5" : "ring-1 ring-white/10";
const cardShadow = isStartingUp
    ? "shadow-2xl"
    : "shadow-2xl shadow-violet-500/10";

// Text classes for Starting Up (dark text on light bg) vs Scaling Up (light text on dark bg)
const titleText = isStartingUp ? "text-violet-600" : "text-violet-400";
const descText = isStartingUp ? "text-gray-600" : "text-gray-400";
const labelText = isStartingUp ? "text-gray-500" : "text-gray-400";
const grantText = isStartingUp ? "text-violet-950" : "text-white";
const headingText = isStartingUp ? "text-gray-900" : "text-gray-100";
const excludedText = isStartingUp ? "text-red-800" : "text-red-200";
const includedText = isStartingUp ? "text-emerald-800" : "text-emerald-200";
const dividerBorder = isStartingUp ? "border-gray-200" : "border-white/10";
---

<div
    class="-m-2 grid grid-cols-1 rounded-4xl bg-white/2.5 shadow-[inset_0_0_2px_1px_#ffffff4d] ring-1 ring-black/5 max-lg:mx-auto max-lg:w-full max-lg:max-w-md dark:shadow-[inset_0_0_2px_1px_#ffffff32]"
>
    <div
        class="grid grid-cols-1 rounded-4xl p-2 py-2 shadow-md shadow-black/5 dark:shadow-none"
    >
        <div class:list={["rounded-3xl py-3", cardBg, cardShadow, cardRing]}>
            <!-- Section 1: Award Name -->
            <div class="p-6 pb-4">
                <h2 class:list={["text-md font-semibold", headingText]}>
                    {name.replace(programme?.name ?? "", "").trim()}
                    <br />
                    {programme?.name}
                </h2>
            </div>

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 2: Grant Information -->
            <div class="p-6">
                <div class="flex flex-col gap-1">
                    <div class:list={["text-sm", labelText]}>
                        <p>Grant of up to</p>
                    </div>
                    <div class:list={["text-5xl font-semibold", grantText]}>
                        {grantFormatted}
                    </div>
                    <div class="mt-4">
                        <h3 class:list={["text-sm/6 font-medium", headingText]}>
                            Your grant usability:
                        </h3>

                        <ul class="mt-3 space-y-1">
                            {
                                grantUsabilityEntries
                                    .filter(([_, isIncluded]) => isIncluded)
                                    .map(([label]) => (
                                        <li
                                            class:list={[
                                                "group flex items-start gap-2 text-xs/6",
                                                includedText,
                                            ]}
                                        >
                                            <span class="inline-flex h-6 items-center">
                                                <Icon
                                                    name="circle-check"
                                                    style="solid"
                                                    class="h-3.5 w-3.5 text-green-500"
                                                />
                                            </span>
                                            <span>{label}</span>
                                        </li>
                                    ))
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 3: Programme Information -->
            <div class="p-6">
                <a
                    href={programme?.path ?? "#"}
                    class={`group block mb-4 -mx-2 px-2 py-2 rounded-xl transition-colors ${theme.hoverBg}`}
                >
                    <p class:list={["text-sm", labelText]}>
                        Programme enrollment to
                    </p>
                    <div class="flex items-center gap-2 mt-2">
                        <span
                            class={`inline-flex items-center gap-2 rounded-md px-2.5 py-1 text-xs font-medium ${theme.badgeBg} ${theme.badgeText} ${theme.badgeRing}`}
                        >
                            <DynamicIcon icon={programme?.icon} />
                            {programme?.name}
                        </span>
                    </div>
                    {
                        programme?.description && (
                            <p
                                class={`text-xs leading-relaxed mt-3 ${theme.descriptionText}`}
                            >
                                {programme.description}
                            </p>
                        )
                    }
                </a>

                <div class="pt-2">
                    <h3
                        class:list={["text-sm/6 font-medium pb-2", headingText]}
                    >
                        Your programme services:
                    </h3>
                    <ul class="space-y-2">
                        {
                            services.map((service) => (
                                <li
                                    class={`group flex items-start gap-3 text-xs/6 ${theme.serviceItemText}`}
                                >
                                    <span class="inline-flex h-6 items-center">
                                        {service.icon && (
                                            <DynamicIcon icon={service.icon} />
                                        )}
                                    </span>
                                    {service.name}
                                </li>
                            ))
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
