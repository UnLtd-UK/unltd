---
import DynamicIcon from "@components/DynamicIcon.astro";
import Icon from "@components/Icon.astro";
import {
    awards,
    type EligibilityCriteria,
    type EligibilityValue,
} from "@data/awards";
import { allCriteria } from "@data/criteriaMapping";

interface Programme {
    icon: string;
    name: string;
    slug: string;
    colour?: "amber" | "purple" | string;
    description?: string;
}

interface ProgrammeService {
    name: string;
    icon: string;
    included?: boolean;
}

type GrantUsability = Record<string, boolean>;

interface AwardProps {
    code: string;
    name: string;
    description: string;
    grant: number;
    programme: Programme;
    grantUsability: GrantUsability;
    programmeServices: ProgrammeService[];
    eligibility?: EligibilityCriteria;
}

const {
    code,
    name,
    description,
    grant,
    programme,
    grantUsability,
    programmeServices,
    eligibility,
} = Astro.props as AwardProps;

// Theme tokens for programme colours on different card backgrounds
const colourThemes = {
    // Amber on light background (Starting Up cards)
    "amber-light": {
        badgeBg: "bg-amber-100 dark:bg-amber-100",
        badgeText: "text-amber-800 dark:text-amber-800",
        badgeRing: "ring-1 ring-amber-600/20 dark:ring-amber-600/20",
        serviceItemText: "text-amber-700 dark:text-amber-700",
        descriptionText: "text-amber-700/80 dark:text-amber-700/80",
        hoverBg: "hover:bg-amber-50 dark:hover:bg-amber-50",
    },
    // Amber on dark background (Scaling Up cards)
    "amber-dark": {
        badgeBg: "bg-amber-500/20 dark:bg-amber-500/20",
        badgeText: "text-amber-400 dark:text-amber-400",
        badgeRing: "ring-1 ring-amber-400/30 dark:ring-amber-400/30",
        serviceItemText: "text-amber-400 dark:text-amber-400",
        descriptionText: "text-amber-400/80 dark:text-amber-400/80",
        hoverBg: "hover:bg-amber-500/10 dark:hover:bg-amber-500/10",
    },
    // Purple on light background (Starting Up cards)
    "purple-light": {
        badgeBg: "bg-purple-100 dark:bg-purple-100",
        badgeText: "text-purple-800 dark:text-purple-800",
        badgeRing: "ring-1 ring-purple-600/20 dark:ring-purple-600/20",
        serviceItemText: "text-purple-700 dark:text-purple-700",
        descriptionText: "text-purple-700/80 dark:text-purple-700/80",
        hoverBg: "hover:bg-purple-50 dark:hover:bg-purple-50",
    },
    // Purple on dark background (Scaling Up cards)
    "purple-dark": {
        badgeBg: "bg-purple-500/20 dark:bg-purple-500/20",
        badgeText: "text-purple-300 dark:text-purple-300",
        badgeRing: "ring-1 ring-purple-400/30 dark:ring-purple-400/30",
        serviceItemText: "text-purple-300 dark:text-purple-300",
        descriptionText: "text-purple-300/80 dark:text-purple-300/80",
        hoverBg: "hover:bg-purple-500/10 dark:hover:bg-purple-500/10",
    },
} as const;

// Determine if this is a Starting Up award (lighter) or Scaling Up award (darker)
const isStartingUp = name.toLowerCase().includes("starting up");

// Select the appropriate theme based on programme colour and card background
const themeKey =
    `${programme?.colour ?? "amber"}-${isStartingUp ? "light" : "dark"}` as keyof typeof colourThemes;
const theme = colourThemes[themeKey] ?? colourThemes["amber-light"];

const grantFormatted = new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    maximumFractionDigits: 0,
}).format(grant ?? 0);

const grantUsabilityEntries = Object.entries(grantUsability ?? {});
const services = programmeServices ?? [];

// Card background and text classes based on award type
// Starting Up: Light background for early-stage ventures
// Scaling Up: Dark background for established ventures
const cardBg = isStartingUp
    ? "bg-white dark:bg-white"
    : "bg-slate-900 dark:bg-slate-900";
const cardRing = isStartingUp ? "ring-1 ring-black/5" : "ring-1 ring-white/10";
const cardShadow = isStartingUp
    ? "shadow-2xl"
    : "shadow-2xl shadow-violet-500/10";

// Text classes for Starting Up (dark text on light bg) vs Scaling Up (light text on dark bg)
const titleText = isStartingUp ? "text-violet-600" : "text-violet-400";
const descText = isStartingUp ? "text-gray-600" : "text-gray-400";
const labelText = isStartingUp ? "text-gray-500" : "text-gray-400";
const grantText = isStartingUp ? "text-violet-950" : "text-white";
const headingText = isStartingUp ? "text-gray-900" : "text-gray-100";
const excludedText = isStartingUp ? "text-red-800" : "text-red-200";
const includedText = isStartingUp ? "text-emerald-800" : "text-emerald-200";
const dividerBorder = isStartingUp ? "border-gray-200" : "border-white/10";

// Dynamically determine which criteria vary across awards
// A criterion varies if not all awards have the same value
function criteriaVariesAcrossAwards(slug: string): boolean {
    const values = awards.map((a) =>
        JSON.stringify(a.eligibility[slug as keyof EligibilityCriteria]),
    );
    const uniqueValues = new Set(values);
    return uniqueValues.size > 1;
}

// Calculate the maximum number of sectors across all awards (to determine "All sectors")
const maxSectorCount = Math.max(
    ...awards.map((a) => {
        const sectors = a.eligibility.sector_classification;
        return Array.isArray(sectors) ? sectors.length : 0;
    }),
);

// Format eligibility value for display
function formatEligibilityValue(
    value: EligibilityValue,
    slug?: string,
): {
    text: string;
    items?: string[];
    type: "yes" | "no" | "info" | "na" | "array";
} {
    if (value === null || value === undefined)
        return { text: "N/A", type: "na" };
    if (value === true) return { text: "Yes", type: "yes" };
    if (value === false) return { text: "No", type: "no" };
    if (Array.isArray(value)) {
        // If this is sector_classification and all sectors are selected, show "All sectors"
        if (
            slug === "sector_classification" &&
            value.length >= maxSectorCount
        ) {
            return { text: "All sectors", type: "info" };
        }
        return { text: "", items: value, type: "array" };
    }
    return { text: String(value), type: "info" };
}

// Get criteria that vary across awards and have a value for this award
const varyingCriteria = allCriteria
    .filter((c) => criteriaVariesAcrossAwards(c.slug))
    .filter((c) => eligibility?.[c.slug as keyof EligibilityCriteria] !== null);
---

<div
    class="-m-2 grid grid-cols-1 rounded-4xl bg-white/2.5 shadow-[inset_0_0_2px_1px_#ffffff4d] ring-1 ring-black/5 max-lg:mx-auto max-lg:w-full max-lg:max-w-md dark:shadow-[inset_0_0_2px_1px_#ffffff32]"
>
    <div
        class="grid grid-cols-1 rounded-4xl p-2 py-2 shadow-md shadow-black/5 dark:shadow-none"
    >
        <div class:list={["rounded-3xl py-3", cardBg, cardShadow, cardRing]}>
            <!-- Section 1: Award Name -->
            <div class="p-6 pb-4">
                <h2 class:list={["text-md font-semibold", headingText]}>
                    {name.replace(programme?.name ?? "", "").trim()}
                    <br />
                    {programme?.name}
                </h2>
            </div>

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 2: Grant Information -->
            <div class="p-6">
                <div class="flex flex-col gap-1">
                    <div class:list={["text-xs uppercase", labelText]}>
                        <p>Up to</p>
                    </div>
                    <div class:list={["text-5xl font-semibold", grantText]}>
                        {grantFormatted}
                    </div>
                    <div class="mt-4">
                        <h3 class:list={["text-sm/6 font-medium", headingText]}>
                            Can be used for:
                        </h3>

                        <ul class="mt-3 space-y-1">
                            {
                                grantUsabilityEntries
                                    .filter(([_, isIncluded]) => isIncluded)
                                    .map(([label]) => (
                                        <li
                                            class:list={[
                                                "group flex items-start gap-2 text-xs/6",
                                                includedText,
                                            ]}
                                        >
                                            <span class="inline-flex h-6 items-center">
                                                <Icon
                                                    name="circle-check"
                                                    style="solid"
                                                    class="h-3.5 w-3.5 text-green-500"
                                                />
                                            </span>
                                            <span>{label}</span>
                                        </li>
                                    ))
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 3: Programme Information -->
            <div class="p-6">
                <p class:list={["text-xs uppercase", labelText]}>Programme</p>

                <a
                    href={`/awards/${programme.slug}`}
                    class={`group block mb-4 -mx-2 px-5 py-2 rounded-xl transition-colors ${theme.hoverBg}`}
                >
                    <div class="flex items-center gap-2 mt-2">
                        <span
                            class={`inline-flex items-center gap-2 rounded-md px-2.5 py-1 text-xs font-medium ${theme.badgeBg} ${theme.badgeText} ${theme.badgeRing}`}
                        >
                            <DynamicIcon icon={programme?.icon} />
                            {programme?.name}
                        </span>
                    </div>
                    {
                        programme?.description && (
                            <p
                                class={`text-xs leading-relaxed mt-3 ${theme.descriptionText}`}
                            >
                                {programme.description &&
                                programme.description.length > 100
                                    ? programme.description.slice(0, 100) +
                                      "..."
                                    : programme.description}
                            </p>
                        )
                    }

                    <div class="pt-2">
                        <h3
                            class:list={[
                                "text-sm/6 font-medium pb-2",
                                headingText,
                            ]}
                        >
                            Award includes:
                        </h3>
                        <ul class="space-y-2">
                            {
                                services.map((service) => (
                                    <li
                                        class={`group flex items-start gap-3 text-xs/6 ${theme.serviceItemText}`}
                                    >
                                        <span class="inline-flex h-6 items-center">
                                            {service.icon && (
                                                <DynamicIcon
                                                    icon={service.icon}
                                                />
                                            )}
                                        </span>
                                        {service.name}
                                    </li>
                                ))
                            }
                        </ul>
                    </div>
                </a>
            </div>

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 4: Mini Eligibility Criteria -->
            {
                eligibility && varyingCriteria.length > 0 && (
                    <div class="p-6 pb-4">
                        <p class:list={["text-xs uppercase mb-4", labelText]}>
                            Key eligibility criteria
                        </p>
                        <ul
                            class:list={[
                                "rounded-lg overflow-hidden divide-y",
                                isStartingUp
                                    ? "divide-gray-100 border border-gray-100"
                                    : "divide-white/5 border border-white/5",
                            ]}
                        >
                            {varyingCriteria.map((criterion, index) => {
                                const value =
                                    eligibility[
                                        criterion.slug as keyof EligibilityCriteria
                                    ];
                                const formatted = formatEligibilityValue(
                                    value,
                                    criterion.slug,
                                );
                                const valueColorClass =
                                    formatted.type === "yes"
                                        ? isStartingUp
                                            ? "text-emerald-600"
                                            : "text-emerald-400"
                                        : formatted.type === "no"
                                          ? isStartingUp
                                              ? "text-red-600"
                                              : "text-red-400"
                                          : isStartingUp
                                            ? "text-violet-700"
                                            : "text-violet-300";
                                const rowBg =
                                    index % 2 === 0
                                        ? isStartingUp
                                            ? "bg-gray-50/50"
                                            : "bg-white/[0.02]"
                                        : isStartingUp
                                          ? "bg-white"
                                          : "bg-transparent";
                                return (
                                    <li
                                        class:list={[
                                            "flex flex-col gap-2 px-4 py-3",
                                            rowBg,
                                        ]}
                                    >
                                        <span
                                            class:list={[
                                                "text-xs leading-relaxed",
                                                isStartingUp
                                                    ? "text-gray-700"
                                                    : "text-gray-300",
                                            ]}
                                        >
                                            {criterion.name}
                                        </span>
                                        {formatted.type === "array" &&
                                        formatted.items ? (
                                            <span class="flex flex-wrap gap-1">
                                                {formatted.items.map((item) => (
                                                    <span
                                                        class:list={[
                                                            "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium whitespace-nowrap",
                                                            isStartingUp
                                                                ? "bg-violet-100 text-violet-700"
                                                                : "bg-violet-500/20 text-violet-300",
                                                        ]}
                                                    >
                                                        {item}
                                                    </span>
                                                ))}
                                            </span>
                                        ) : (
                                            <span
                                                class:list={[
                                                    "text-xs font-semibold",
                                                    valueColorClass,
                                                ]}
                                            >
                                                {formatted.text}
                                            </span>
                                        )}
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                )
            }

            <div
                aria-hidden="true"
                class:list={["mx-6 border-t border-dotted", dividerBorder]}
            >
            </div>

            <!-- Section 5: Eligibility Criteria Link -->
            <div class="p-6 pt-4">
                <a
                    href={`/awards/eligibility-criteria#${code}`}
                    class:list={[
                        "group flex items-center justify-between gap-2 px-4 py-3 rounded-xl transition-colors",
                        isStartingUp
                            ? "bg-zinc-50 hover:bg-zinc-100 text-zinc-700"
                            : "bg-zinc-950 hover:bg-zinc-900 text-zinc-300",
                    ]}
                >
                    <span class="text-xs font-medium"
                        >View full eligibility criteria</span
                    >
                    <Icon
                        name="arrow-right"
                        style="solid"
                        class="h-4 w-4 transition-transform group-hover:translate-x-1"
                    />
                </a>
            </div>
        </div>
    </div>
</div>
