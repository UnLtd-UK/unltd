---
import slugify from "slugify";

import { programmes } from "@data/programmes.js";
import {
  programmeEvents as fetchedProgrammeEvents,
  isPastEvent,
  sortEvents,
} from "@data/eventCollections";
import { palette } from "@data/palette.js";
import Container from "@components/Container.astro";
import ProgrammeBig from "@components/awards/programme/ProgrammeBig.astro";
import ProgrammeSmall from "@components/awards//programme/ProgrammeSmall.astro";
import ProgrammeDetails from "@components/awards/programme/ProgrammeDetails.astro";

// Filter programmes to only show those with 'published' status
const publishedProgrammes = programmes.filter(
  (programme) => programme.status === "published",
);

const EVENTBRITE_PROGRAMMES_COLLECTION_URL =
  typeof process !== "undefined" &&
  process.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL
    ? process.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL
    : (import.meta.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL ??
      "https://www.eventbrite.com/cc/for-social-entrepreneurs-4794111");

const programmeEvents = sortEvents(fetchedProgrammeEvents).filter(
  (event) => event.start?.local && !isPastEvent(event),
);

const slugOptions = {
  lower: true,
  strict: true,
  locale: "en",
  trim: true,
};

const enrichedProgrammes = publishedProgrammes.map((programme) => ({
  ...programme,
  slug: slugify(programme.name, slugOptions),
}));
---

<Container bg="bg-violet-50 dark:bg-violet-950">
  <div id="programmes" class="flex flex-col gap-10 py-10">
    <div class="max-w-4xl">
      <h2
        class="mt-2 text-4xl font-bold tracking-tight text-violet-900 dark:text-violet-100 sm:text-5xl"
      >
        Programmes
      </h2>
      <p
        class="mt-6 max-w-2xl text-lg leading-8 text-violet-800 dark:text-violet-300"
      >
        Depending on your age and the sectors in which your social venture
        operates in, you will be assigned to one of our programmes for funding
        and up to a year of support. Our programmes are designed to provide
        specialised support that align with the needs of you and your social
        venture.
      </p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {
        enrichedProgrammes.map((programme, i) => (
          <ProgrammeSmall
            key={i}
            image={
              programme.image && programme.image.id ? programme.image.id : false
            }
            icon={programme.icon}
            styles={palette[programme.name]}
            name={programme.name}
            logo={
              programme.logo && programme.logo.id ? programme.logo.id : false
            }
            stage={programme.stage}
            age={programme.age}
            geography={programme.geography}
            focus={programme.focus}
            slogan={programme.slogan}
            description={programme.description}
            slug={programme.slug}
            services={programme.services}
            eligibilities={programme.eligibilities}
            code={programme.code}
            from={programme.from}
            till={programme.till}
            label={programme.label}
          />
        ))
      }
    </div>

    <div aria-live="polite">
      {
        enrichedProgrammes.map((programme) => (
          <section
            class="programme-drawer"
            data-programme-drawer={programme.slug}
            aria-hidden="true"
            hidden
          >
            <div class="programme-drawer__backdrop" data-programme-dismiss />
            <div
              class="programme-drawer__panel"
              role="dialog"
              aria-modal="true"
              aria-label={`${programme.name} programme details`}
            >
              <div class="programme-drawer__panel-inner">
                <div class="programme-drawer__panel-header">
                  <p class="text-sm uppercase tracking-[0.3em] text-violet-200">
                    Programme overview
                  </p>
                  <button
                    type="button"
                    class="programme-drawer__close"
                    data-programme-dismiss
                  >
                    <span class="sr-only">Close programme drawer</span>
                    <i class="fa-regular fa-circle-xmark text-2xl" />
                  </button>
                </div>
                <div class="programme-drawer__content">
                  <ProgrammeDetails
                    programme={programme}
                    programmesList={publishedProgrammes}
                    styles={palette[programme.name]}
                    includeOther={false}
                  />
                </div>
              </div>
            </div>
          </section>
        ))
      }
    </div>
    <!-- <div class="flex flex-col gap-10 py-20">
      <div class="max-w-4xl">
        <h2
          id="sessions"
          class="mt-2 text-4xl font-bold tracking-tight text-violet-900 dark:text-violet-100 sm:text-5xl"
        >
          Sessions
        </h2>
        <p
          class="mt-6 max-w-2xl text-lg leading-8 text-violet-800 dark:text-violet-300"
        >
          We run regular information sessions on our programmes, where you will
          get an overview of what to expect, the support available, and the
          application process. You will also have the chance to ask any
          questions. In addition, we host Connect and Share sessions, an
          opportunity to meet existing Award Winners, hear about their
          experiences, and learn directly from their journeys.
        </p>
      </div>
      {
        programmeEvents.length > 0 ? (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {programmeEvents.map((event) => {
              const startDate = new Date(event.start.local);
              const endDate = event.end?.local
                ? new Date(event.end.local)
                : null;
              const description =
                event.summary ?? event.description?.text ?? "";
              const truncatedDescription =
                description.length > 160
                  ? `${description.substring(0, 157).trimEnd()}...`
                  : description;
              const locationLabel = event.online_event
                ? "Online"
                : (event.venue?.name ?? "Venue to be confirmed");
              const statusLabel = event.status
                ? event.status.replace(/_/g, " ")
                : "Event";
              const dateLabel = startDate.toLocaleDateString("en-GB", {
                weekday: "long",
                day: "numeric",
                month: "long",
                year: "numeric",
              });
              const startTime = startDate.toLocaleTimeString("en-GB", {
                hour: "2-digit",
                minute: "2-digit",
              });
              const endTime = endDate
                ? endDate.toLocaleTimeString("en-GB", {
                    hour: "2-digit",
                    minute: "2-digit",
                  })
                : null;
              const timeLabel = endTime
                ? `${startTime} â€“ ${endTime}`
                : startTime;
              const timezoneLabel = event.start?.timezone
                ? ` ${event.start.timezone}`
                : "";
              const locationIconClass = event.online_event
                ? "fa-solid fa-video"
                : "fa-solid fa-location-dot";
              const attendanceIconClass = event.online_event
                ? "fa-solid fa-laptop"
                : "fa-solid fa-people-group";
              const attendanceLabel = event.online_event
                ? "Virtual session"
                : "In-person session";
              const headerWeekday = startDate.toLocaleDateString("en-GB", {
                weekday: "short",
              });
              const headerMonth = startDate.toLocaleDateString("en-GB", {
                month: "short",
              });

              return (
                <article class="group relative flex flex-col overflow-hidden rounded-2xl border border-violet-200 bg-white/90 shadow-sm transition duration-500 hover:-translate-y-2 hover:shadow-2xl dark:border-violet-900/60 dark:bg-violet-950/80">
                  <div class="relative flex items-center gap-4 bg-linear-to-r from-violet-900 to-amber-900 p-6 text-violet-50">
                    <div class="flex h-16 w-16 flex-col items-center justify-center rounded-xl bg-violet-950/40 text-xs font-semibold uppercase tracking-wide">
                      <span>{headerWeekday}</span>
                      <span class="text-2xl font-bold leading-none">
                        {startDate.getDate()}
                      </span>
                      <span>{headerMonth}</span>
                    </div>
                    <div class="flex flex-1 flex-col gap-1">
                      <span class="text-xs font-semibold uppercase tracking-[0.18em] text-violet-100/70">
                        {statusLabel}
                      </span>
                      <h3 class="text-md font-semibold leading-tight">
                        <a
                          href={event.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="relative inline-flex items-start gap-2 pr-8 text-violet-50 transition-colors duration-300 hover:text-white focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
                        >
                          <span class="absolute inset-0" />
                          {event.name.text}
                        </a>
                      </h3>
                    </div>
                    <span
                      class="pointer-events-none absolute -right-10 top-1/2 hidden h-32 w-32 -translate-y-1/2 rounded-full bg-white/20 blur-2xl opacity-0 transition-opacity duration-500 group-hover:opacity-100 md:block"
                      aria-hidden="true"
                    />
                  </div>
                  <div class="flex flex-1 flex-col gap-5 p-6">
                    {truncatedDescription && (
                      <p class="text-sm leading-relaxed text-violet-800 dark:text-violet-200">
                        {truncatedDescription}
                      </p>
                    )}
                    <dl class="grid gap-3 text-sm text-violet-700 dark:text-violet-200">
                      <div class="flex items-center gap-2">
                        <i
                          class="fa-regular fa-calendar-days text-violet-500"
                          aria-hidden="true"
                        />
                        <span>{dateLabel}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i
                          class="fa-regular fa-clock text-violet-500"
                          aria-hidden="true"
                        />
                        <span>
                          {timeLabel}
                          {timezoneLabel}
                        </span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i
                          class={`${locationIconClass} text-violet-500`}
                          aria-hidden="true"
                        />
                        <span>{locationLabel}</span>
                      </div>
                    </dl>
                    <div class="mt-auto flex items-center justify-between gap-3 border-t border-violet-100 pt-4 text-xs font-semibold uppercase tracking-[0.24em] text-violet-600 dark:border-violet-900/60 dark:text-violet-300">
                      <span class="flex items-center gap-2">
                        <i
                          class={`${attendanceIconClass} text-violet-500`}
                          aria-hidden="true"
                        />
                        {attendanceLabel}
                      </span>
                      <a
                        href={event.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 rounded-full bg-violet-900 px-4 py-2 text-xs text-violet-50 transition duration-300 hover:bg-violet-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-violet-500 dark:bg-violet-700 dark:hover:bg-violet-500 whitespace-nowrap tracking-normal normal-case"
                      >
                        Reserve spot
                        <i
                          class="fa-solid fa-arrow-up-right-from-square text-xs"
                          aria-hidden="true"
                        />
                      </a>
                    </div>
                  </div>
                </article>
              );
            })}
          </div>
        ) : (
          <div class="rounded-xl border border-violet-200 bg-violet-50 p-6 text-violet-900">
            <p>
              We do not have any upcoming sessions scheduled right now. Please
              check our Eventbrite collection for the latest dates.
            </p>
            <a
              href={EVENTBRITE_PROGRAMMES_COLLECTION_URL}
              target="_blank"
              rel="noopener noreferrer"
              class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-violet-900 hover:text-violet-700 transition-colors duration-200"
            >
              Browse events on Eventbrite >
            </a>
          </div>
        )
      }
    </div> -->
  </div>
</Container>

<style is:inline>
  :global(html.programme-drawer-open) {
    overflow: hidden;
  }

  .programme-drawer {
    position: fixed;
    inset: 0;
    z-index: 60;
    display: none;
  }

  .programme-drawer.programme-drawer--visible {
    display: block;
  }

  .programme-drawer__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(9, 9, 11, 0.65);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 200ms ease;
  }

  .programme-drawer--active .programme-drawer__backdrop {
    opacity: 1;
  }

  .programme-drawer__panel {
    position: absolute;
    inset: 0 0 0 auto;
    width: min(100%, 56rem);
    max-width: 100%;
    transform: translateX(100%);
    transition: transform 320ms ease;
    display: flex;
    justify-content: flex-end;
  }

  .programme-drawer--active .programme-drawer__panel {
    transform: translateX(0);
  }

  .programme-drawer__panel-inner {
    width: 100%;
    background: #f5f3ff;
    height: 100%;
    overflow-y: auto;
    box-shadow: -25px 0 45px rgba(15, 23, 42, 0.35);
    padding: 2rem 1rem;
  }

  .programme-drawer__panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(79, 70, 229, 0.2);
    margin-bottom: 1.5rem;
  }

  .programme-drawer__content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .programme-drawer__close {
    border-radius: 9999px;
    width: 2.5rem;
    height: 2.5rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    color: #4c1d95;
    transition:
      background 200ms ease,
      transform 200ms ease;
  }

  .programme-drawer__close:hover {
    background: rgba(255, 255, 255, 1);
    transform: scale(1.05);
  }

  .programme-drawer__close:focus-visible {
    outline: 2px solid #7c3aed;
    outline-offset: 2px;
  }

  @media (max-width: 640px) {
    .programme-drawer__panel-inner {
      padding: 1.5rem 1rem 3rem;
    }
  }
</style>

<script>
  (() => {
    if (typeof window === "undefined") return;

    const drawerClassVisible = "programme-drawer--visible";
    const drawerClassActive = "programme-drawer--active";
    const rootLockClass = "programme-drawer-open";

    const drawers = new Map();
    document.querySelectorAll("[data-programme-drawer]").forEach((drawer) => {
      const slug = drawer.getAttribute("data-programme-drawer");
      if (slug) {
        drawers.set(slug, drawer);
      }
    });

    let activeDrawer = null;

    const openDrawer = (slug) => {
      const drawer = drawers.get(slug);
      if (!drawer) return;

      if (activeDrawer && activeDrawer !== drawer) {
        closeDrawer(activeDrawer, false);
      }

      drawer.hidden = false;
      drawer.setAttribute("aria-hidden", "false");
      drawer.classList.add(drawerClassVisible);

      requestAnimationFrame(() => {
        drawer.classList.add(drawerClassActive);
      });

      document.documentElement.classList.add(rootLockClass);
      activeDrawer = drawer;
    };

    const finishClose = (drawer) => {
      drawer.classList.remove(drawerClassVisible);
      drawer.hidden = true;
    };

    const closeDrawer = (drawer, unlockRoot = true) => {
      if (!drawer) return;

      drawer.classList.remove(drawerClassActive);
      drawer.setAttribute("aria-hidden", "true");

      const panel = drawer.querySelector(".programme-drawer__panel");
      if (panel) {
        let handled = false;
        const onTransitionEnd = () => {
          handled = true;
          finishClose(drawer);
          panel.removeEventListener("transitionend", onTransitionEnd);
        };

        panel.addEventListener("transitionend", onTransitionEnd, {
          once: true,
        });
        window.setTimeout(() => {
          if (!handled) {
            finishClose(drawer);
            panel.removeEventListener("transitionend", onTransitionEnd);
          }
        }, 400);
      } else {
        finishClose(drawer);
      }

      if (unlockRoot) {
        document.documentElement.classList.remove(rootLockClass);
      }

      activeDrawer = null;
    };

    document.querySelectorAll("[data-programme-trigger]").forEach((trigger) => {
      trigger.addEventListener("click", (event) => {
        if (
          event.defaultPrevented ||
          event.button !== 0 ||
          event.metaKey ||
          event.ctrlKey ||
          event.shiftKey ||
          event.altKey
        ) {
          return;
        }

        const slug = trigger.getAttribute("data-programme-trigger");
        if (!slug) return;

        event.preventDefault();
        openDrawer(slug);
      });
    });

    document.querySelectorAll("[data-programme-dismiss]").forEach((element) => {
      element.addEventListener("click", () => {
        if (activeDrawer) {
          closeDrawer(activeDrawer);
        }
      });
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && activeDrawer) {
        closeDrawer(activeDrawer);
        document.documentElement.classList.remove(rootLockClass);
      }
    });
  })();
</script>
