---
import slugify from "slugify";

import { programmes } from "@data/programmes.js";
import {
  programmeEvents as fetchedProgrammeEvents,
  isPastEvent,
  sortEvents,
} from "@data/eventCollections";
import { palette } from "@data/palette.js";
import Container from "@components/Container.astro";
import ProgrammeBig from "@components/awards/programme/ProgrammeBig.astro";
import ProgrammeSmall from "@components/awards//programme/ProgrammeSmall.astro";

// Filter programmes to only show those with 'published' status
const publishedProgrammes = programmes.filter(
  (programme) => programme.status === "published",
);

const EVENTBRITE_PROGRAMMES_COLLECTION_URL =
  typeof process !== "undefined" &&
  process.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL
    ? process.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL
    : (import.meta.env.EVENTBRITE_PROGRAMMES_COLLECTION_URL ??
      "https://www.eventbrite.com/cc/for-social-entrepreneurs-4794111");

const programmeEvents = sortEvents(fetchedProgrammeEvents).filter(
  (event) => event.start?.local && !isPastEvent(event),
);
---

<Container bg="bg-violet-50 dark:bg-violet-950">
  <div class="flex flex-col gap-10 py-10">
    <div class="max-w-4xl">
      <h2
        id="programmes"
        class="mt-2 text-4xl font-bold tracking-tight text-violet-900 dark:text-violet-100 sm:text-5xl"
      >
        Programmes
      </h2>
      <p
        class="mt-6 max-w-2xl text-lg leading-8 text-violet-800 dark:text-violet-300"
      >
        Depending on your age, location, and the sectors in which you and your
        social venture operate, you will be assigned to one of our programmes
        for funding and up to a year of support. Our programmes are designed to
        provide specialised support that align with the needs of you and your
        social venture.
      </p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {
        publishedProgrammes.map((programme, i) => (
          <ProgrammeSmall
            key={i}
            image={
              programme.image && programme.image.id ? programme.image.id : false
            }
            icon={programme.icon}
            styles={palette[programme.name]}
            name={programme.name}
            logo={
              programme.logo && programme.logo.id ? programme.logo.id : false
            }
            stage={programme.stage}
            age={programme.age}
            geography={programme.geography}
            focus={programme.focus}
            slogan={programme.slogan}
            description={programme.description}
            slug={slugify(programme.name, {
              lower: true,
              strict: true,
              locale: "en",
              trim: true,
            })}
            services={programme.services}
            eligibilities={programme.eligibilities}
            code={programme.code}
            from={programme.from}
            till={programme.till}
            label={programme.label}
          />
        ))
      }
    </div>
  </div>
  <div class="flex flex-col gap-10 py-20">
    <div class="max-w-4xl">
      <h2
        id="sessions"
        class="mt-2 text-4xl font-bold tracking-tight text-violet-900 dark:text-violet-100 sm:text-5xl"
      >
        Sessions
      </h2>
      <p
        class="mt-6 max-w-2xl text-lg leading-8 text-violet-800 dark:text-violet-300"
      >
        We run regular information sessions on our programmes, where you will
        get an overview of what to expect, the support available, and the
        application process. You will also have the chance to ask any questions.
        In addition, we host Connect and Share sessions, an opportunity to meet
        existing Award Winners, hear about their experiences, and learn directly
        from their journeys.
      </p>
    </div>
    {
      programmeEvents.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {programmeEvents.map((event) => {
            const startDate = new Date(event.start.local);
            const description = event.summary ?? event.description?.text ?? "";
            const truncatedDescription =
              description.length > 160
                ? `${description.substring(0, 157).trimEnd()}...`
                : description;
            const locationLabel = event.online_event
              ? "Online"
              : (event.venue?.name ?? "Venue to be confirmed");
            const statusLabel = event.status
              ? event.status.replace(/_/g, " ")
              : "Event";

            return (
              <article class="flex flex-col justify-between border-solid border-2 bg-violet-50 border-violet-100 rounded-xl group relative transition ease-in-out delay-150 hover:-translate-y-2 duration-300 overflow-hidden">
                <div class="flex flex-row flex-1">
                  <div class="basis-1/4 flex-none flex gap-2 flex-col bg-violet-200 rounded-l-lg p-2 items-center justify-center">
                    <span class="text-xs text-violet-900 font-bold">
                      {startDate.toLocaleString("en-GB", { weekday: "long" })}
                    </span>
                    <div class="flex flex-col items-center gap-1">
                      <span class="uppercase text-xs text-violet-900">
                        {startDate.toLocaleString("en-GB", { month: "long" })}
                      </span>
                      <span class="text-xl font-bold text-violet-50 w-10 h-10 bg-violet-900 rounded-full flex justify-center items-center">
                        {startDate.getDate()}
                      </span>
                    </div>
                    <span class="uppercase text-sm text-violet-900">
                      {startDate.toLocaleTimeString("en-GB", {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </span>
                  </div>
                  <div class="basis-3/4 flex flex-col gap-3 py-4 px-6">
                    <p class="text-xs uppercase text-violet-700">
                      {locationLabel}
                    </p>
                    <h3 class="text-sm font-semibold leading-6 text-violet-900">
                      <a
                        href={event.url}
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        <span class="absolute inset-0" />
                        {event.name.text}
                      </a>
                    </h3>
                    {truncatedDescription && (
                      <p class="text-sm text-violet-800">
                        {truncatedDescription}
                      </p>
                    )}
                    <div class="mt-auto flex flex-row gap-3 items-center">
                      <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ring-violet-200 text-violet-900 bg-violet-100">
                        {statusLabel}
                      </span>
                      <a
                        href={event.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 text-sm font-semibold text-violet-900 hover:text-violet-700 transition-colors duration-200"
                      >
                        View on Eventbrite >
                      </a>
                    </div>
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      ) : (
        <div class="rounded-xl border border-violet-200 bg-violet-50 p-6 text-violet-900">
          <p>
            We do not have any upcoming sessions scheduled right now. Please
            check our Eventbrite collection for the latest dates.
          </p>
          <a
            href={EVENTBRITE_PROGRAMMES_COLLECTION_URL}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-violet-900 hover:text-violet-700 transition-colors duration-200"
          >
            Browse events on Eventbrite >
          </a>
        </div>
      )
    }
  </div>
</Container>
