---
/**
 * RoundBanner Component
 * A full-width banner showing application round status
 * Ideal for page headers or prominent placement
 *
 * Can be used with or without props:
 * - Without props: fetches rounds data automatically
 * - With props: uses provided currentRound/nextOpenRound
 */

import CountdownTimer from "./CountdownTimer.jsx";
import {
    getWidgetDisplayData,
    processAllRounds,
} from "@utils/application-rounds.js";
import { rounds } from "@data/rounds.js";

interface Props {
    currentRound?: any;
    nextOpenRound?: any;
    showApplyButton?: boolean;
    applyUrl?: string;
}

const {
    currentRound: propCurrentRound,
    nextOpenRound: propNextOpenRound,
    showApplyButton = true,
    applyUrl = "https://portal.unltd.org.uk/apply",
} = Astro.props;

// If props not provided, fetch rounds data automatically
let currentRound = propCurrentRound;
let nextOpenRound = propNextOpenRound;

if (!currentRound) {
    const processed = processAllRounds(rounds);
    currentRound = processed.currentRound;
    nextOpenRound = processed.nextOpenRound;
}

// Get all display data from utility
const widget = getWidgetDisplayData(currentRound, nextOpenRound);

if (!widget) return null;

const {
    roundName,
    status,
    isAcceptingApplications,
    isClosingSoon,
    capacityPercentage,
    capacityUrgency,
    daysRemaining,
    daysUntilOpen,
    closesDate,
    dates,
} = widget;

// Capacity bar segments
const capacitySegments = [20, 40, 60, 80, 100];

// Status indicator bar color (top accent stripe)
const indicatorBarColor = isAcceptingApplications
    ? capacityUrgency === "critical"
        ? "bg-gradient-to-r from-red-500 to-red-400"
        : capacityUrgency === "high"
          ? "bg-gradient-to-r from-amber-500 to-amber-400"
          : "bg-gradient-to-r from-emerald-500 to-emerald-400"
    : status === "upcoming"
      ? "bg-gradient-to-r from-indigo-500 to-indigo-400"
      : "bg-gradient-to-r from-amber-500 to-amber-400";

// Icon background color
const iconBgColor = isAcceptingApplications
    ? "bg-emerald-500/20"
    : status === "upcoming"
      ? "bg-indigo-500/20"
      : "bg-amber-500/20";

// Icon color
const iconColor = isAcceptingApplications
    ? "text-emerald-400"
    : status === "upcoming"
      ? "text-indigo-400"
      : "text-amber-400";

// Badge styling
const badgeStyles = isAcceptingApplications
    ? "bg-emerald-500/20 text-emerald-400 ring-emerald-500/30"
    : status === "upcoming"
      ? "bg-indigo-500/20 text-indigo-400 ring-indigo-500/30"
      : "bg-amber-500/20 text-amber-400 ring-amber-500/30";

// CTA button styling
const ctaStyles = isAcceptingApplications
    ? "bg-emerald-500 hover:bg-emerald-400 text-white"
    : status === "upcoming"
      ? "bg-indigo-500 hover:bg-indigo-400 text-white"
      : "bg-amber-500 hover:bg-amber-400 text-white";
---

<div
    class="relative overflow-hidden bg-gradient-to-r from-violet-950 via-violet-900 to-violet-950 border-b border-violet-800/50"
>
    <!-- Status indicator bar -->
    <div class={`absolute top-0 left-0 right-0 h-1 ${indicatorBarColor}`}></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <div
            class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
        >
            <!-- Left: Status and round info -->
            <div class="flex items-center gap-4">
                <!-- Icon -->
                <div
                    class={`hidden sm:flex h-10 w-10 items-center justify-center rounded-lg ${iconBgColor} shrink-0`}
                >
                    <i
                        class={`fa-solid ${
                            isAcceptingApplications
                                ? "fa-door-open"
                                : status === "upcoming"
                                  ? "fa-calendar-clock"
                                  : "fa-magnifying-glass-chart"
                        } ${iconColor}`}
                        aria-hidden="true"></i>
                </div>

                <div>
                    <div class="flex items-center gap-3 flex-wrap">
                        <h3 class="text-base font-semibold text-white">
                            {roundName} Round
                        </h3>
                        <!-- Status badge -->
                        <span
                            class={`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ${badgeStyles}`}
                        >
                            {
                                isAcceptingApplications ? (
                                    <>
                                        <span class="relative flex h-1.5 w-1.5">
                                            <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-current opacity-75" />
                                            <span class="relative inline-flex h-1.5 w-1.5 rounded-full bg-current" />
                                        </span>
                                        Open
                                    </>
                                ) : status === "upcoming" ? (
                                    <>
                                        <i class="fa-regular fa-clock text-[10px]" />
                                        Coming soon
                                    </>
                                ) : (
                                    <>
                                        <i class="fa-solid fa-spinner text-[10px]" />
                                        Assessing
                                    </>
                                )
                            }
                        </span>
                    </div>

                    <!-- Subtitle based on status -->
                    <p class="text-sm text-violet-300 mt-0.5">
                        {
                            isAcceptingApplications ? (
                                <>
                                    Closes{" "}
                                    <span class="font-medium text-white">
                                        {dates?.closes}
                                    </span>
                                    {daysRemaining !== undefined && (
                                        <span class="text-violet-400 ml-1">
                                            ({daysRemaining}{" "}
                                            {daysRemaining === 1
                                                ? "day"
                                                : "days"}{" "}
                                            left)
                                        </span>
                                    )}
                                </>
                            ) : status === "upcoming" ? (
                                <>
                                    Opens{" "}
                                    <span class="font-medium text-white">
                                        {dates?.opens}
                                    </span>
                                    {daysUntilOpen !== undefined &&
                                        daysUntilOpen > 0 && (
                                            <span class="text-violet-400 ml-1">
                                                ({daysUntilOpen}{" "}
                                                {daysUntilOpen === 1
                                                    ? "day"
                                                    : "days"}
                                                )
                                            </span>
                                        )}
                                </>
                            ) : (
                                <>
                                    Results from{" "}
                                    <span class="font-medium text-white">
                                        {dates?.resultsStart}
                                    </span>
                                </>
                            )
                        }
                    </p>
                </div>
            </div>

            <!-- Center: Capacity (only when accepting applications) -->
            {
                isAcceptingApplications && (
                    <div class="flex items-center gap-4 lg:flex-1 lg:justify-center lg:max-w-xs">
                        <div class="flex-1 max-w-48">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs text-violet-400">
                                    Capacity
                                </span>
                                <span
                                    class={`text-xs font-semibold ${
                                        capacityUrgency === "critical"
                                            ? "text-red-400"
                                            : capacityUrgency === "high"
                                              ? "text-amber-400"
                                              : "text-emerald-400"
                                    }`}
                                >
                                    {capacityPercentage}% filled
                                </span>
                            </div>
                            <div class="flex gap-0.5">
                                {capacitySegments.map((threshold) => (
                                    <div
                                        class={`h-1.5 flex-1 rounded-full transition-all ${
                                            capacityPercentage >= threshold
                                                ? threshold <= 40
                                                    ? "bg-emerald-400"
                                                    : threshold <= 60
                                                      ? "bg-amber-400"
                                                      : "bg-red-400"
                                                : "bg-white/10"
                                        }`}
                                    />
                                ))}
                            </div>
                        </div>

                        {isClosingSoon && (
                            <div class="shrink-0">
                                <CountdownTimer
                                    client:load
                                    closesDate={closesDate}
                                />
                            </div>
                        )}
                    </div>
                )
            }

            <!-- Right: CTA -->
            <div class="flex items-center gap-3 shrink-0">
                <a
                    href="/awards#eligibility-checker"
                    class={`inline-flex items-center gap-2 px-4 py-2 font-semibold rounded-lg text-sm transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105 ${ctaStyles}`}
                >
                    <i
                        class="fa-solid fa-clipboard-check text-xs"
                        aria-hidden="true"></i>
                    Check Eligibility
                </a>

                <a
                    href="/awards"
                    class="hidden lg:inline-flex items-center gap-1.5 text-sm font-medium text-amber-400 hover:text-amber-300 transition-colors"
                >
                    View Awards
                    <i class="fa-solid fa-arrow-right text-xs"></i>
                </a>
            </div>
        </div>
    </div>
</div>
