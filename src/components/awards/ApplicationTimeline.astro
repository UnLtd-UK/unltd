---
/**
 * ApplicationTimeline Component
 * Displays a visual timeline of key application dates
 */

import Container from "@components/Container.astro";
import { rounds } from "@data/rounds.js";
import { processAllRounds } from "@utils/application-rounds.js";

const {
    all: applicationRounds,
    currentRound,
    nextOpenRound,
} = processAllRounds(rounds);

// Get up to 4 rounds for display (current/next plus future)
const displayRounds = applicationRounds
    .filter((round: any) => !round.phase || round.phase !== "completed")
    .slice(0, 4);

// Format time from ISO date string (24-hour clock)
const formatTime = (isoString: string) => {
    const date = new Date(isoString);
    return date.toLocaleTimeString("en-GB", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
    });
};

const getStatusBadge = (round: any) => {
    if (round.isOpen)
        return { label: "Open Now", class: "bg-emerald-500 text-white" };
    if (round.isUpcoming)
        return { label: "Upcoming", class: "bg-indigo-500 text-white" };
    if (round.isInAssessment)
        return { label: "Assessing", class: "bg-amber-500 text-white" };
    if (round.isInResults)
        return { label: "Results", class: "bg-violet-500 text-white" };
    return {
        label: round.phaseInfo?.shortLabel || "Closed",
        class: "bg-slate-500 text-white",
    };
};
---

<Container bg="bg-violet-50 dark:bg-violet-950">
    <div class="py-16">
        <div class="text-center mb-12">
            <span
                class="inline-flex items-center rounded-full bg-violet-200 dark:bg-violet-800 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-violet-700 dark:text-violet-200"
            >
                Key Dates
            </span>
            <h2
                class="text-3xl md:text-4xl font-bold text-violet-950 dark:text-violet-50 mb-4 mt-4"
            >
                Application Timeline
            </h2>
            <p
                class="text-lg text-violet-700 dark:text-violet-200 max-w-2xl mx-auto"
            >
                Plan ahead with our application round schedule. Each round has
                distinct phases from application to results.
            </p>
        </div>

        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full text-sm border-collapse">
                <thead>
                    <tr class="bg-violet-100 dark:bg-violet-900">
                        <th
                            class="text-left py-4 px-4 font-semibold text-violet-900 dark:text-violet-100 border-b border-violet-200 dark:border-violet-700"
                        >
                            Status
                        </th>
                        <th
                            class="text-left py-4 px-4 font-semibold text-violet-900 dark:text-violet-100 border-b border-violet-200 dark:border-violet-700"
                        >
                            Applications Open
                        </th>
                        <th
                            class="text-left py-4 px-4 font-semibold text-violet-900 dark:text-violet-100 border-b border-violet-200 dark:border-violet-700"
                        >
                            Applications Close
                        </th>
                        <th
                            class="text-left py-4 px-4 font-semibold text-violet-900 dark:text-violet-100 border-b border-violet-200 dark:border-violet-700"
                        >
                            Assessment Period
                        </th>
                        <th
                            class="text-left py-4 px-4 font-semibold text-violet-900 dark:text-violet-100 border-b border-violet-200 dark:border-violet-700"
                        >
                            Results Sent
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {
                        displayRounds.map((round: any, index: number) => {
                            const status = getStatusBadge(round);
                            const isHighlighted =
                                round.isOpen ||
                                (round.isUpcoming && index === 0);
                            return (
                                <tr
                                    class={`${isHighlighted ? "bg-violet-50 dark:bg-violet-900/50" : "bg-white dark:bg-violet-950"} border-b border-violet-100 dark:border-violet-800`}
                                >
                                    <td class="py-4 px-4">
                                        <span
                                            class={`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${status.class}`}
                                        >
                                            {status.label}
                                        </span>
                                    </td>
                                    <td class="py-4 px-4 text-violet-900 dark:text-violet-100">
                                        <div class="font-medium">
                                            {round.dates.opensShort}
                                        </div>
                                        <div class="text-xs text-violet-500 dark:text-violet-400">
                                            {formatTime(round.opensDate)}
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-violet-900 dark:text-violet-100">
                                        <div class="font-medium">
                                            {round.dates.closesShort}
                                        </div>
                                        <div class="text-xs text-violet-500 dark:text-violet-400">
                                            {formatTime(round.closesDate)}
                                        </div>
                                    </td>
                                    <td class="py-4 px-4 text-violet-700 dark:text-violet-300">
                                        {round.dates.assessmentStartShort} –{" "}
                                        {round.dates.assessmentEndShort}
                                    </td>
                                    <td class="py-4 px-4 text-violet-700 dark:text-violet-300">
                                        {round.dates.resultsStartShort} –{" "}
                                        {round.dates.resultsEndShort}
                                    </td>
                                </tr>
                            );
                        })
                    }
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden space-y-4">
            {
                displayRounds.map((round: any) => {
                    const status = getStatusBadge(round);
                    return (
                        <div class="bg-white dark:bg-violet-900 rounded-xl p-4 border border-violet-200 dark:border-violet-700 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <span
                                    class={`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${status.class}`}
                                >
                                    {status.label}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <p class="text-violet-500 dark:text-violet-400 text-xs uppercase tracking-wide">
                                        Opens
                                    </p>
                                    <p class="font-medium text-violet-900 dark:text-violet-100">
                                        {round.dates.opensShort}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-violet-500 dark:text-violet-400 text-xs uppercase tracking-wide">
                                        Closes
                                    </p>
                                    <p class="font-medium text-violet-900 dark:text-violet-100">
                                        {round.dates.closesShort}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-violet-500 dark:text-violet-400 text-xs uppercase tracking-wide">
                                        Assessment
                                    </p>
                                    <p class="text-violet-700 dark:text-violet-300">
                                        {round.dates.assessmentStartShort} –{" "}
                                        {round.dates.assessmentEndShort}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-violet-500 dark:text-violet-400 text-xs uppercase tracking-wide">
                                        Results
                                    </p>
                                    <p class="text-violet-700 dark:text-violet-300">
                                        {round.dates.resultsStartShort} –{" "}
                                        {round.dates.resultsEndShort}
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                })
            }
        </div>

        <div class="mt-8 text-center">
            <p class="text-sm text-violet-600 dark:text-violet-400">
                Need to plan further ahead? <a
                    href="mailto:awards@unltd.org.uk"
                    class="underline font-medium hover:text-violet-800 dark:hover:text-violet-200"
                    >Contact us</a
                > for information about future rounds.
            </p>
        </div>
    </div>
</Container>
