---
/**
 * RoundWidget Component
 * A sleek, compact widget showing application round status at a glance
 * Links to /awards1/application-rounds for full details
 */

import CountdownTimer from "./CountdownTimer.jsx";
import { getWidgetDisplayData } from "@utils/application-rounds.js";

interface Props {
    currentRound: any;
    nextOpenRound?: any;
}

const { currentRound, nextOpenRound } = Astro.props;

// Get all display data from utility
const widget = getWidgetDisplayData(currentRound, nextOpenRound);

if (!widget) return null;

const {
    roundName,
    status,
    isAcceptingApplications,
    isClosingSoon,
    capacityPercentage,
    capacityUrgency,
    daysRemaining,
    daysUntilOpen,
    closesDate,
    dates,
} = widget;

// Capacity bar segments
const capacitySegments = [20, 40, 60, 80, 100];
---

<a
    href="/awards1/application-rounds"
    class="group relative block overflow-hidden rounded-xl border border-violet-600/50 bg-gradient-to-br from-violet-900/80 to-violet-950/80 backdrop-blur transition-all duration-300 hover:border-violet-500 hover:shadow-lg hover:shadow-violet-500/10"
>
    <!-- Status indicator bar -->
    <div
        class={`h-1 w-full ${
            isAcceptingApplications
                ? capacityUrgency === "critical"
                    ? "bg-gradient-to-r from-red-500 to-red-400"
                    : capacityUrgency === "high"
                      ? "bg-gradient-to-r from-amber-500 to-amber-400"
                      : "bg-gradient-to-r from-emerald-500 to-emerald-400"
                : status === "upcoming"
                  ? "bg-gradient-to-r from-indigo-500 to-indigo-400"
                  : "bg-gradient-to-r from-amber-500 to-amber-400"
        }`}
    >
    </div>

    <div class="p-4">
        <!-- Header row -->
        <div class="flex items-center justify-between gap-3 mb-3">
            <div class="flex items-center gap-2">
                <div
                    class={`flex h-8 w-8 items-center justify-center rounded-lg ${
                        isAcceptingApplications
                            ? "bg-emerald-500/20"
                            : status === "upcoming"
                              ? "bg-indigo-500/20"
                              : "bg-amber-500/20"
                    }`}
                >
                    <i
                        class={`fa-solid ${
                            isAcceptingApplications
                                ? "fa-door-open text-emerald-400"
                                : status === "upcoming"
                                  ? "fa-calendar-clock text-indigo-400"
                                  : "fa-magnifying-glass-chart text-amber-400"
                        } text-sm`}
                        aria-hidden="true"></i>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-white">
                        {roundName}
                    </h3>
                    <p class="text-xs text-violet-400">Application Round</p>
                </div>
            </div>

            <!-- Status badge -->
            {
                isAcceptingApplications ? (
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-emerald-500/20 px-2.5 py-1 text-xs font-semibold text-emerald-400 ring-1 ring-emerald-500/30">
                        <span class="relative flex h-1.5 w-1.5">
                            <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-75" />
                            <span class="relative inline-flex h-1.5 w-1.5 rounded-full bg-emerald-500" />
                        </span>
                        Open
                    </span>
                ) : status === "upcoming" ? (
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-indigo-500/20 px-2.5 py-1 text-xs font-semibold text-indigo-400 ring-1 ring-indigo-500/30">
                        <i class="fa-regular fa-clock text-[10px]" />
                        Coming soon
                    </span>
                ) : (
                    <span class="inline-flex items-center gap-1.5 rounded-full bg-amber-500/20 px-2.5 py-1 text-xs font-semibold text-amber-400 ring-1 ring-amber-500/30">
                        <i class="fa-solid fa-spinner text-[10px]" />
                        Assessing
                    </span>
                )
            }
        </div>

        <!-- Content based on status -->
        {
            isAcceptingApplications ? (
                <div class="space-y-3">
                    <!-- Capacity bar -->
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="text-xs text-violet-300">
                                Capacity
                            </span>
                            <span
                                class={`text-xs font-semibold ${
                                    capacityUrgency === "critical"
                                        ? "text-red-400"
                                        : capacityUrgency === "high"
                                          ? "text-amber-400"
                                          : "text-emerald-400"
                                }`}
                            >
                                {capacityPercentage}% filled
                            </span>
                        </div>
                        <div class="flex gap-0.5">
                            {capacitySegments.map((threshold) => (
                                <div
                                    class={`h-1.5 flex-1 rounded-full transition-all ${
                                        capacityPercentage >= threshold
                                            ? threshold <= 40
                                                ? "bg-emerald-400"
                                                : threshold <= 60
                                                  ? "bg-amber-400"
                                                  : "bg-red-400"
                                            : "bg-white/10"
                                    }`}
                                />
                            ))}
                        </div>
                    </div>

                    <!-- Time remaining -->
                    <div class="flex items-center justify-between pt-2 border-t border-white/5">
                        {isClosingSoon ? (
                            <CountdownTimer
                                client:load
                                closesDate={closesDate}
                            />
                        ) : (
                            <div class="flex items-center gap-2">
                                <i class="fa-regular fa-clock text-violet-400 text-xs" />
                                <span class="text-xs text-violet-300">
                                    <span class="font-semibold text-white">
                                        {daysRemaining}
                                    </span>{" "}
                                    {daysRemaining === 1 ? "day" : "days"} left
                                </span>
                            </div>
                        )}
                        <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-400 group-hover:text-amber-300 transition-colors">
                            View application round
                            <i class="fa-solid fa-arrow-right text-[10px] transition-transform group-hover:translate-x-0.5" />
                        </span>
                    </div>
                </div>
            ) : status === "upcoming" ? (
                <div class="flex items-center justify-between pt-1">
                    <div class="flex items-center gap-2">
                        <i class="fa-regular fa-calendar text-indigo-400 text-xs" />
                        <span class="text-xs text-violet-300">
                            Opens{" "}
                            <span class="font-medium text-white">
                                {dates?.opens}
                            </span>
                            {daysUntilOpen > 0 && (
                                <span class="text-violet-500 ml-1">
                                    ({daysUntilOpen}{" "}
                                    {daysUntilOpen === 1 ? "day" : "days"})
                                </span>
                            )}
                        </span>
                    </div>
                    <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-400 group-hover:text-amber-300 transition-colors">
                        View details
                        <i class="fa-solid fa-arrow-right text-[10px] transition-transform group-hover:translate-x-0.5" />
                    </span>
                </div>
            ) : (
                <div class="flex items-center justify-between pt-1">
                    <div class="flex items-center gap-2">
                        <i class="fa-regular fa-envelope text-amber-400 text-xs" />
                        <span class="text-xs text-violet-300">
                            Results from{" "}
                            <span class="font-medium text-white">
                                {dates?.resultsStart}
                            </span>
                        </span>
                    </div>
                    <span class="inline-flex items-center gap-1 text-xs font-medium text-amber-400 group-hover:text-amber-300 transition-colors">
                        View details
                        <i class="fa-solid fa-arrow-right text-[10px] transition-transform group-hover:translate-x-0.5" />
                    </span>
                </div>
            )
        }
    </div>
</a>
