---
import Fields from "@components/fields/Fields.astro";
// import Grant from "@components/GrantCard2.astro";
import { marked } from "marked";
marked.use({ mangle: false, headerIds: false });

const {
  slug,
  name,
  description,
  grant_title,
  grant_amount,
  grant_description,
  sections,
  portal_value,
  portal_text,
  stage_text,
} = Astro.props;

const selectedStage = portal_value;
const selectedStageDisplay = portal_text;
---

<main class="flex flex-col gap-5">
  {
    selectedStage && (
      <div class="bg-amber-50 border border-amber-200 rounded-md p-6 shadow-sm">
        <div class="flex gap-3">
          <div class="flex-shrink-0">
            <svg
              class="h-5 w-5 text-amber-600"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-medium text-amber-800">
              Application Preview
            </h3>
            <div class="mt-2 text-sm text-amber-700">
              <p>
                This application preview is based on your social venture which{" "}
                <strong>{stage_text}</strong>.
              </p>
              <p class="mt-2">
                When you fill out the actual application form, you will need to
                select <strong>"{portal_text}"</strong> for question 4.1.
              </p>
            </div>
          </div>
        </div>
      </div>
    )
  }

  {
    sections.map((section, index) => {
      return (
        <>
          <form
            action="#"
            id={section.sections_id.slug}
            method="POST"
            class="shadow-xl sm:overflow-hidden rounded-md flex flex-col gap-10 bg-white"
          >
            <div class="">
              <div class="bg-violet-100 px-10 pt-10 pb-5 sticky top-0 rounded-t-md rounded-x-md flex flex-row gap-3 items-center">
                <span class="text-violet-600 border-full h-8 w-8 bg-white flex justify-center items-center rounded-full border border-violet-200">
                  {index + 1}
                </span>
                <h3 class="text-lg font-medium leading-6 text-violet-700">
                  {section.sections_id.name}
                </h3>
              </div>

              {section.sections_id.description && (
                <div
                  class="bg-violet-100 px-10 pt-5 pb-10 border-b border-violet-200 shadow-xs text-sm text-violet-500 leading-relaxed prose"
                  id={`${section.sections_id.slug}-description}`}
                  set:html={marked.parse(section.sections_id.description)}
                />
              )}
            </div>
            <div class="flex flex-col gap-10 pb-10 px-7 md:px-10">
              {section.sections_id.fields.map((field, index) => {
                // Check if this is the stage selection field and we have a selected stage
                const isStageField =
                  field.fields_id.slug ===
                  "please-tell-us-the-stage-your-social-venture-is-at  ";
                const shouldDisable =
                  isStageField && selectedStage
                    ? true
                    : field.fields_id.disabled;
                const preselectedValue =
                  isStageField && selectedStage ? selectedStage : slug;

                return (
                  <Fields
                    name={field.fields_id.name}
                    description={field.fields_id.description}
                    slug={field.fields_id.slug}
                    type={field.fields_id.type}
                    input_type={field.fields_id.input_type}
                    required={field.fields_id.required}
                    disabled={shouldDisable}
                    options={field.fields_id.select_options}
                    max_length={field.fields_id.max_length}
                    prefix={field.fields_id.prefix}
                    suffix={field.fields_id.suffix}
                    alias={preselectedValue}
                    number={index + 1}
                  />
                );
              })}
            </div>
          </form>
        </>
      );
    })
  }
</main>
