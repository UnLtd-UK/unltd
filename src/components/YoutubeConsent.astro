---
interface Props {
    url: string;
    title?: string;
    consentKey?: string;
    aspectClass?: string;
    iframeClass?: string;
    description?: string;
    allow?: string;
    consentCategory?: string;
}

const {
    url,
    title = "YouTube video",
    consentKey = "youtube-consent",
    aspectClass = "aspect-video",
    iframeClass = "w-full h-full rounded-xl",
    description = "We need your permission to load this YouTube video. YouTube may collect data about your activity.",
    allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",
    consentCategory,
}: Props = Astro.props;

const createEmbedUrls = (value: string) => {
    try {
        const parsed = new URL(value);
        const params = new URLSearchParams(parsed.search);
        let videoId = params.get("v");

        if (!videoId) {
            const segments = parsed.pathname.split("/").filter(Boolean);
            const embedIndex = segments.indexOf("embed");
            if (embedIndex > -1 && segments[embedIndex + 1]) {
                videoId = segments[embedIndex + 1];
            } else if (
                segments.length &&
                segments[segments.length - 1].length >= 11
            ) {
                videoId = segments[segments.length - 1];
            }
        }

        if (!videoId) {
            return {
                embed: value,
                watch: value,
            };
        }

        params.delete("v");
        const query = params.toString();
        const search = query ? `?${query}` : "";

        return {
            embed: `https://www.youtube-nocookie.com/embed/${videoId}${search}`,
            watch: `https://www.youtube.com/watch?v=${videoId}`,
        };
    } catch (error) {
        return {
            embed: value,
            watch: value,
        };
    }
};

const { embed: embedUrl, watch: watchUrl } = createEmbedUrls(url);
const wrapperId = `youtube-consent-${Date.now().toString(36)}-${Math.random()
    .toString(36)
    .slice(2)}`;
---

<div
    id={wrapperId}
    class="youtube-consent"
    data-consent-key={consentKey}
    data-embed-url={embedUrl}
    data-watch-url={watchUrl}
    data-consent-category={consentCategory}
>
    <div class={`relative w-full ${aspectClass}`} data-state="prompt">
        <div
            data-consent-prompt
            class="flex h-full flex-col items-center justify-center gap-6 rounded-xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center dark:border-slate-600 dark:bg-slate-900"
        >
            <p class="text-sm text-slate-700 dark:text-slate-200">
                {description}
            </p>
            <div class="flex flex-col gap-2 sm:flex-row">
                <button
                    type="button"
                    data-accept
                    class="cursor-pointer inline-flex justify-center rounded-md bg-amber-500 px-4 py-2 text-sm font-semibold text-black shadow-sm hover:bg-amber-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-500"
                >
                    Allow YouTube
                </button>
                <button
                    type="button"
                    data-deny
                    class="cursor-pointer inline-flex justify-center rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800"
                >
                    Watch on YouTube
                </button>
            </div>
        </div>
        <div
            data-denied
            class="hidden h-full flex-col items-center justify-center gap-4 rounded-xl border border-slate-200 bg-slate-50 p-6 text-center dark:border-slate-700 dark:bg-slate-900"
        >
            <p class="text-sm text-slate-700 dark:text-slate-200">
                We can&apos;t display this video without your permission.
            </p>
            <a
                href={watchUrl}
                target="_blank"
                rel="noreferrer"
                class="inline-flex items-center justify-center rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800"
            >
                Watch on YouTube.com
            </a>
            <button
                type="button"
                data-reset
                class="text-xs text-slate-500 underline underline-offset-4 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200"
            >
                Change choice
            </button>
        </div>
        <div data-iframe class="hidden h-full w-full">
            <iframe
                data-src={embedUrl}
                title={title}
                class={iframeClass}
                allow={allow}
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
                loading="lazy"></iframe>
        </div>
    </div>
</div>
<script>
    (() => {
        const scriptEl = document.currentScript;
        const root = scriptEl?.previousElementSibling;

        if (!(root instanceof HTMLElement)) {
            console.warn("YouTube consent root not found");
            return;
        }

        const promptEl = root.querySelector("[data-consent-prompt]");
        const deniedEl = root.querySelector("[data-denied]");
        const iframeWrapper = root.querySelector("[data-iframe]");
        const iframeEl = iframeWrapper?.querySelector("iframe");
        const acceptBtn = root.querySelector("[data-accept]");
        const denyBtn = root.querySelector("[data-deny]");
        const resetBtn = root.querySelector("[data-reset]");
        const consentKey = root.dataset.consentKey || "youtube-consent";
        const embed = root.dataset.embedUrl;
        const watch = root.dataset.watchUrl;
        const category = root.dataset.consentCategory;

        const setZarazConsent = (value) => {
            if (!category) return;
            const globalWindow = /** @type {any} */ (window);
            // @ts-ignore â€“ Zaraz is injected by Cloudflare at runtime
            const zaraz = globalWindow?.zaraz;
            if (zaraz?.consent?.set) {
                zaraz.consent.set(category, value);
            }
        };

        const setState = (state) => {
            if (!promptEl || !deniedEl || !iframeWrapper) return;

            promptEl.classList.toggle("hidden", state !== "prompt");
            deniedEl.classList.toggle("hidden", state !== "denied");
            iframeWrapper.classList.toggle("hidden", state !== "granted");
            root.dataset.state = state;
        };

        const remember = (state) => {
            try {
                localStorage.setItem(consentKey, state);
            } catch (error) {
                console.warn("Unable to persist YouTube consent state", error);
            }
        };

        const dispatchChange = (state) => {
            window.dispatchEvent(
                new CustomEvent("youtube-consent-change", {
                    detail: {
                        state,
                        consentKey,
                        category,
                    },
                }),
            );
            if (state === "granted") {
                setZarazConsent(true);
            }
            if (state === "denied") {
                setZarazConsent(false);
            }
        };

        const loadIframe = () => {
            if (iframeEl && !iframeEl.src) {
                iframeEl.src = embed || "";
            }
        };

        const grant = () => {
            loadIframe();
            remember("granted");
            setState("granted");
            dispatchChange("granted");
        };

        const deny = (openLink = false) => {
            remember("denied");
            setState("denied");
            dispatchChange("denied");
            if (openLink && watch) {
                window.open(watch, "_blank", "noopener");
            }
        };

        const reset = () => {
            setState("prompt");
            remember("prompt");
            dispatchChange("prompt");
        };

        acceptBtn?.addEventListener("click", grant);
        denyBtn?.addEventListener("click", () => {
            deny(true);
        });
        resetBtn?.addEventListener("click", reset);

        let storedState = null;
        try {
            storedState = localStorage.getItem(consentKey);
        } catch (error) {
            console.warn("Unable to access YouTube consent state", error);
        }

        if (storedState === "granted") {
            grant();
        } else if (storedState === "denied") {
            deny(false);
        } else {
            setState("prompt");
        }
    })();
</script>
