---
/**
 * SpaceAuth Component
 * Client-side password protection for restricted spaces
 * Uses window.prompt() and localStorage for persistence
 */

interface Props {
    spaceSlug: string;
    spaceName: string;
    password: string;
    access: 'public' | 'unlisted' | 'restricted';
}

const { spaceSlug, spaceName, password, access } = Astro.props;

// Only render auth script for restricted spaces
const isRestricted = access === 'restricted';
---

{isRestricted && (
    <div 
        id="space-auth-gate"
        data-space-slug={spaceSlug}
        data-space-name={spaceName}
        data-password={password}
    >
        <script>
            // Space Authentication Handler
            (function() {
                const gate = document.getElementById('space-auth-gate');
                if (!gate) return;

                const spaceSlug = gate.dataset.spaceSlug;
                const spaceName = gate.dataset.spaceName;
                const correctPassword = gate.dataset.password;
                const storageKey = `space-auth-${spaceSlug}`;

                // Check if already authenticated
                const storedAuth = localStorage.getItem(storageKey);
                if (storedAuth === 'authenticated') {
                    // Already authenticated, remove gate
                    gate.remove();
                    return;
                }

                // Show password prompt
                function promptForPassword() {
                    const enteredPassword = window.prompt(
                        `This area is password protected.\n\nEnter the password for "${spaceName}":`
                    );

                    if (enteredPassword === null) {
                        // User cancelled - redirect to resources page
                        window.location.href = '/resources';
                        return;
                    }

                    if (enteredPassword === correctPassword) {
                        // Correct password - store in localStorage
                        localStorage.setItem(storageKey, 'authenticated');
                        gate.remove();
                    } else {
                        // Wrong password - try again
                        const retry = window.confirm(
                            'Incorrect password. Would you like to try again?'
                        );
                        if (retry) {
                            promptForPassword();
                        } else {
                            window.location.href = '/resources';
                        }
                    }
                }

                // Start authentication flow
                promptForPassword();
            })();
        </script>
    </div>
)}
