---
/**
 * Dynamic Eligibility Page
 *
 * Renders a personalized page for users who pass the eligibility checker.
 * Typeform redirects users to /eligible/{slug} based on their answers.
 *
 * Not indexable (noindex) - only accessible via eligibility checker redirect.
 */

import type { GetStaticPaths } from "astro";
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import EligibleHero from "@components/awards/EligibleHero.astro";
import ResourcesRow from "@components/awards/ResourcesRow.astro";
import AdditionalSupportRow from "@components/awards/AdditionalSupportRow.astro";
import HowApplyingWorks from "@components/awards/HowApplyingWorks.astro";
import WhenToApply from "@components/awards/WhenToApply.astro";
import FrequentlyAskedQuestions from "@components/awards/FrequentlyAskedQuestions.astro";
import ReadyToApplyCTA from "@components/awards/ReadyToApplyCTA.astro";

import {
    eligibilityPages,
    getEligibilityPageWithAwards,
    type EligibilityPage,
} from "@data/eligibilityPages";
import type { Award as AwardType } from "@data/awards";
import { rounds } from "@data/rounds.js";
import { processAllRounds } from "@utils/application-rounds.js";

// Generate static paths for all eligibility slugs
export const getStaticPaths: GetStaticPaths = () => {
    return eligibilityPages.map((page) => ({
        params: { eligible: page.slug },
        props: { pageData: page },
    }));
};

// Get the page data from params
const { eligible } = Astro.params;
const result = getEligibilityPageWithAwards(eligible as string);

// 404 if no matching eligibility page
if (!result) {
    return Astro.redirect("/404");
}

const { page, awards } = result;

// Process rounds for Apply button state
const { currentRound, nextOpenRound } = processAllRounds(rounds);
const isRoundOpen =
    currentRound?.isOpen && currentRound?.capacityPercentage < 100;

// Get the next opening date - use nextOpenRound if available, otherwise currentRound
const nextOpenDate =
    nextOpenRound?.dates?.opens || currentRound?.dates?.opens || "soon";

// Map trading status to application preview slug
const applicationPreviewSlugMap: Record<string, string> = {
    idea: "Idea+stage+or+not+yet+trading",
    "under-1-year": "Trading+for+less+than+1+year",
    "under-4-years": "Trading+for+more+than+1+year",
};
const applicationPreviewSlug =
    applicationPreviewSlugMap[page.tradingStatus] ||
    applicationPreviewSlugMap["idea"];
const applicationPreviewUrl = `/awards/${applicationPreviewSlug}`;

// Page metadata
const breadcrumbs = [
    { name: "Awards", path: "/awards" },
    { name: "Eligible", path: `/eligible/${page.slug}` },
];
---

<Template name={page.title} description={page.description} noindex={true}>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
    </Container>

    <EligibleHero
        awards={awards}
        page={page}
        isRoundOpen={isRoundOpen}
        nextOpenDate={nextOpenDate}
    />
    <ResourcesRow applicationPreviewUrl={applicationPreviewUrl} />
    <AdditionalSupportRow />
    <HowApplyingWorks showResourceLinks={true} showRoundWidget={true} />
    <WhenToApply />
    <FrequentlyAskedQuestions />
    <ReadyToApplyCTA isRoundOpen={isRoundOpen} nextOpenDate={nextOpenDate} />
</Template>
