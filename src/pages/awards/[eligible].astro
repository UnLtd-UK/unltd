---
/**
 * Dynamic Eligibility Page
 *
 * Renders a personalized page for users who pass the eligibility checker.
 * Typeform redirects users to /eligible/{slug} based on their answers.
 *
 * Not indexable (noindex) - only accessible via eligibility checker redirect.
 */

import type { GetStaticPaths } from "astro";
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Award from "@components/awards/Award.astro";
import ApplicationRoundsProcess from "@components/awards/ApplicationRoundsProcess.astro";
import ApplicationTimeline from "@components/awards/ApplicationTimeline.astro";
import Questions from "@components/awards/Questions.astro";

import {
    eligibilityPages,
    getEligibilityPageWithAwards,
    type EligibilityPage,
} from "@data/eligibilityPages";
import type { Award as AwardType } from "@data/awards";
import { rounds } from "@data/rounds.js";
import { processAllRounds } from "@utils/application-rounds.js";

// Generate static paths for all eligibility slugs
export const getStaticPaths: GetStaticPaths = () => {
    return eligibilityPages.map((page) => ({
        params: { eligible: page.slug },
        props: { pageData: page },
    }));
};

// Get the page data from params
const { eligible } = Astro.params;
const result = getEligibilityPageWithAwards(eligible as string);

// 404 if no matching eligibility page
if (!result) {
    return Astro.redirect("/404");
}

const { page, awards } = result;

// Process rounds for Apply button state
const { currentRound, nextOpenRound } = processAllRounds(rounds);
const isRoundOpen =
    currentRound?.isOpen && currentRound?.capacityPercentage < 100;

// Get the next opening date - use nextOpenRound if available, otherwise currentRound
const nextOpenDate =
    nextOpenRound?.dates?.opens || currentRound?.dates?.opens || "soon";

// Map trading status to application preview slug
const applicationPreviewSlugMap: Record<string, string> = {
    idea: "Idea+stage+or+not+yet+trading",
    "under-1-year": "Trading+for+less+than+1+year",
    "under-4-years": "Trading+for+more+than+1+year",
};
const applicationPreviewSlug =
    applicationPreviewSlugMap[page.tradingStatus] ||
    applicationPreviewSlugMap["idea"];
const applicationPreviewUrl = `/awards/${applicationPreviewSlug}`;

// Page metadata
const breadcrumbs = [
    { name: "Awards", path: "/awards" },
    { name: "Eligible", path: `/eligible/${page.slug}` },
];

// Determine singular or plural messaging
const isMultipleAwards = awards.length > 1;
const awardText = isMultipleAwards ? "Awards" : "Award";
const programmeNames = awards.map((a) => a.programme.name);
const uniqueProgrammes = [...new Set(programmeNames)];
---

<Template name={page.title} description={page.description} noindex={true}>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
    </Container>

    <!-- Success Hero -->
    <section
        class="bg-gradient-to-br from-emerald-600 via-emerald-500 to-teal-500 text-white py-12 lg:py-16"
        x-data="{ email: new URLSearchParams(window.location.search).get('email') }"
    >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div
                class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-8 lg:gap-12"
            >
                <!-- Left: Confirmation Text & Apply Button -->
                <div class="flex-1 lg:max-w-xl">
                    <div class="flex items-center gap-4 mb-4">
                        <div
                            class="w-16 h-16 rounded-2xl bg-white/20 flex items-center justify-center"
                        >
                            <i
                                class="fa-solid fa-circle-check text-3xl"
                                aria-hidden="true"></i>
                        </div>
                        <span
                            class="inline-flex items-center rounded-full bg-white/20 px-3 py-1 text-sm font-semibold ring-1 ring-white/30"
                        >
                            <i
                                class="fa-solid fa-sparkles mr-1.5 text-xs"
                                aria-hidden="true"></i>
                            Eligibility Confirmed
                        </span>
                    </div>

                    <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">
                        You're eligible to apply for {
                            isMultipleAwards ? awards.length : "a"
                        }
                        {awardText}
                    </h1>

                    <p class="text-lg text-emerald-100 mb-6">
                        {page.tradingDescription}, which means you can apply for {
                            isMultipleAwards
                                ? "either of these Awards"
                                : "this Award"
                        }.
                    </p>

                    <!-- Info notices -->
                    <div class="flex flex-col gap-3 mb-6">
                        <!-- Email confirmation (client-side) -->
                        <div
                            x-show="email"
                            x-cloak
                            class="flex items-start gap-3 bg-white/10 rounded-lg px-4 py-3 ring-1 ring-white/20"
                        >
                            <i
                                class="fa-solid fa-envelope-circle-check text-emerald-200 mt-0.5"
                                aria-hidden="true"></i>
                            <div>
                                <p class="text-sm text-white">
                                    We've emailed <span
                                        x-text="email"
                                        class="font-semibold"></span> a link to this
                                    page
                                </p>
                            </div>
                        </div>

                        {
                            isMultipleAwards && (
                                <div class="flex items-start gap-3 bg-white/10 rounded-lg px-4 py-3 ring-1 ring-white/20">
                                    <i
                                        class="fa-solid fa-info-circle text-emerald-200 mt-0.5"
                                        aria-hidden="true"
                                    />
                                    <p class="text-sm text-white">
                                        You can only apply for one Award at a
                                        time. Choose the programme that best
                                        fits your needs.
                                    </p>
                                </div>
                            )
                        }
                    </div>

                    <div class="mt-6">
                        {
                            isRoundOpen ? (
                                <a
                                    href="https://portal.unltd.org.uk/apply"
                                    class="inline-flex items-center gap-3 px-8 py-4 bg-white text-emerald-700 font-bold rounded-xl text-lg transition-all duration-200 shadow-xl hover:shadow-2xl hover:scale-105"
                                >
                                    <i
                                        class="fa-solid fa-rocket"
                                        aria-hidden="true"
                                    />
                                    Apply Now
                                    <i
                                        class="fa-solid fa-arrow-right"
                                        aria-hidden="true"
                                    />
                                </a>
                            ) : (
                                <div>
                                    <div class="inline-flex items-center gap-2 px-6 py-3 bg-white/20 text-white font-semibold rounded-xl text-lg ring-1 ring-white/30">
                                        <i
                                            class="fa-solid fa-clock"
                                            aria-hidden="true"
                                        />
                                        Applications open {nextOpenDate}
                                    </div>
                                    <p class="text-emerald-200 text-sm mt-2">
                                        Bookmark this page and come back when
                                        applications open
                                    </p>
                                </div>
                            )
                        }
                    </div>
                </div>

                <!-- Right: Award Cards -->
                <div class="shrink-0 w-full lg:w-auto">
                    <div class="grid grid-cols-2 gap-4">
                        {
                            awards.map((award) => (
                                <div class="w-full max-w-[280px]">
                                    <Award {...award} />
                                </div>
                            ))
                        }
                        {
                            !isMultipleAwards && (
                                <div class="w-full max-w-[280px]">
                                    <div class="h-full min-h-[300px] rounded-4xl border-2 border-dashed border-white/20 bg-white/5 flex flex-col items-center justify-center text-center p-6">
                                        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center mb-4">
                                            <i
                                                class="fa-solid fa-question text-xl text-white/30"
                                                aria-hidden="true"
                                            />
                                        </div>
                                        <p class="text-sm text-white/40 font-medium mb-2">
                                            Other Awards
                                        </p>
                                        <p class="text-xs text-white/30">
                                            Additional Awards may be available
                                            based on your eligibility
                                        </p>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Resources Row -->
    <section
        class="bg-emerald-700 dark:bg-emerald-900 border-t border-emerald-600"
    >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p
                class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-4"
            >
                <i class="fa-solid fa-books mr-2" aria-hidden="true"></i>
                Resources to help you apply
            </p>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Preview Application Questions -->
                <a
                    href={applicationPreviewUrl}
                    class="group flex items-center gap-3 p-4 bg-white/10 hover:bg-white/20 rounded-xl ring-1 ring-white/10 hover:ring-white/30 transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-emerald-400/20 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-file-lines text-emerald-300"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white">
                            Application Preview
                        </p>
                        <p class="text-xs text-emerald-200">
                            See the questions
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-arrow-right text-emerald-300 group-hover:text-white group-hover:translate-x-1 transition-all"
                        aria-hidden="true"></i>
                </a>

                <!-- Budget Guidance -->
                <a
                    href="/resources/award-budget-guidance"
                    class="group flex items-center gap-3 p-4 bg-white/10 hover:bg-white/20 rounded-xl ring-1 ring-white/10 hover:ring-white/30 transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-coins text-amber-300"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white">
                            Budget Guidance
                        </p>
                        <p class="text-xs text-emerald-200">
                            Plan your spending
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-arrow-right text-emerald-300 group-hover:text-white group-hover:translate-x-1 transition-all"
                        aria-hidden="true"></i>
                </a>

                <!-- Panel Meeting Guide -->
                <a
                    href="/resources/panel-meeting-guide"
                    class="group flex items-center gap-3 p-4 bg-white/10 hover:bg-white/20 rounded-xl ring-1 ring-white/10 hover:ring-white/30 transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-violet-500/20 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-users text-violet-300"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white">
                            Panel Meeting Guide
                        </p>
                        <p class="text-xs text-emerald-200">
                            Prepare for interview
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-arrow-right text-emerald-300 group-hover:text-white group-hover:translate-x-1 transition-all"
                        aria-hidden="true"></i>
                </a>

                <!-- Pre-application Sessions -->
                <a
                    href="https://www.eventbrite.com/cc/for-social-entrepreneurs-4794111"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group flex items-center gap-3 p-4 bg-white/10 hover:bg-white/20 rounded-xl ring-1 ring-white/10 hover:ring-white/30 transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-calendar-check text-blue-300"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white">
                            Info Sessions
                        </p>
                        <p class="text-xs text-emerald-200">
                            Join a live Q&A on Eventbrite
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-arrow-up-right-from-square text-emerald-300 group-hover:text-white transition-all"
                        aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- Additional Support Row -->
    <section
        class="bg-slate-100 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800"
    >
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p
                class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-4"
            >
                <i
                    class="fa-solid fa-hand-holding-heart mr-2"
                    aria-hidden="true"></i>
                Need extra support? We're here to help
            </p>
            <div class="grid sm:grid-cols-3 gap-4">
                <!-- Visual Impairment Support -->
                <a
                    href="mailto:awardapplications@unltd.org.uk"
                    class="group flex items-center gap-3 p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-blue-300 dark:hover:border-blue-600 hover:shadow-md transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-eye text-blue-600 dark:text-blue-400"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p
                            class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                        >
                            Visual Impairment
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            Screen reader assistance
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-envelope text-slate-400 group-hover:text-blue-500 transition-all"
                        aria-hidden="true"></i>
                </a>

                <!-- Additional Needs Support -->
                <a
                    href="/resources/assistance-for-those-with-additional-support-needs"
                    class="group flex items-center gap-3 p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-emerald-300 dark:hover:border-emerald-600 hover:shadow-md transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-hands-holding-heart text-emerald-600 dark:text-emerald-400"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p
                            class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                        >
                            Additional Needs
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            1-to-1 assistance sessions
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-up-right-from-square text-slate-400 group-hover:text-emerald-500 group-hover:translate-x-1 transition-all"
                        aria-hidden="true"></i>
                </a>

                <!-- Wales Support -->
                <a
                    href="/resources/assistance-for-those-living-in-wales"
                    class="group flex items-center gap-3 p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-rose-300 dark:hover:border-rose-600 hover:shadow-md transition-all duration-200"
                >
                    <div
                        class="w-10 h-10 rounded-lg bg-rose-100 dark:bg-rose-900/50 flex items-center justify-center shrink-0"
                    >
                        <i
                            class="fa-solid fa-dragon text-rose-600 dark:text-rose-400"
                            aria-hidden="true"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p
                            class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                        >
                            Living in Wales
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            Local support networks
                        </p>
                    </div>
                    <i
                        class="fa-solid fa-arrow-right text-slate-400 group-hover:text-rose-500 group-hover:translate-x-1 transition-all"
                        aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- Application Rounds Process -->
    <div id="application-rounds">
        <ApplicationRoundsProcess
            showResourceLinks={true}
            showRoundWidget={true}
        />
    </div>

    <!-- Timeline -->
    <!-- <ApplicationTimeline /> -->

    <!-- FAQ -->
    <Questions />

    <!-- Final CTA -->
    <section class="bg-violet-950 text-white py-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-3xl font-bold mb-4">Ready to apply?</h2>
            <p class="text-violet-200 text-lg mb-8 max-w-2xl mx-auto">
                You've got everything you need. If the round is open, submit
                your application through our portal.
            </p>
            {
                isRoundOpen ? (
                    <a
                        href="https://portal.unltd.org.uk/apply"
                        class="inline-flex items-center gap-2 px-8 py-4 bg-amber-500 hover:bg-amber-400 text-amber-950 font-bold rounded-xl text-lg transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-105"
                    >
                        <i class="fa-solid fa-rocket" aria-hidden="true" />
                        Start Your Application
                        <i class="fa-solid fa-arrow-right" aria-hidden="true" />
                    </a>
                ) : (
                    <div class="space-y-4">
                        <div class="inline-flex items-center gap-2 px-8 py-4 bg-violet-800 text-violet-300 font-semibold rounded-xl text-lg">
                            <i class="fa-solid fa-clock" aria-hidden="true" />
                            Applications open {nextOpenDate}
                        </div>
                        <p class="text-violet-400 text-sm">
                            Use this time to prepare your application using the
                            resources above.
                        </p>
                    </div>
                )
            }
        </div>
    </section>
</Template>
