---
/**
 * Unified Eligibility Page
 *
 * Renders a personalized page for users who pass the eligibility checker.
 * Typeform redirects users to /awards/{slug} based on their answers.
 *
 * This replaces both [eligible].astro and [application_preview].astro
 * by combining eligibility confirmation with application preview functionality.
 *
 * Not indexable (noindex) - only accessible via eligibility checker redirect.
 */

// TYPES
import type { GetStaticPaths } from "astro";

// DATA
import {
    getNewApplications,
    getApplicationWithAwards,
} from "@data/applications.js";
import { rounds } from "@data/rounds.js";
import { processAllRounds } from "@utils/application-rounds.js";

// STATIC PATHS
export const getStaticPaths: GetStaticPaths = () => {
    const newApplications = getNewApplications();
    return newApplications.map((app) => ({
        params: { slug: app.slug },
        props: { applicationData: app },
    }));
};

// PAGE DATA
const { slug } = Astro.params;
const result = getApplicationWithAwards(slug as string);

if (!result) {
    return Astro.redirect("/404");
}

const { application, awards } = result;

// DEBUG: Log awards data
console.log("DEBUG [slug].astro - slug:", slug);
console.log("DEBUG [slug].astro - awards count:", awards?.length);
console.log(
    "DEBUG [slug].astro - award codes:",
    awards?.map((a) => a.code),
);

// Page metadata from Directus (with fallbacks)
const pageTitle =
    application.page_title || application.name || "Your Eligibility";
const pageDescription =
    application.page_description ||
    application.description ||
    "You're eligible to apply for an UnLtd Award";

// ROUNDS
const { currentRound, nextOpenRound } = processAllRounds(rounds);
// Only check capacity if capacity tracking is enabled for this round
const isRoundOpen =
    currentRound?.isOpen &&
    (!currentRound?.hasCapacity || currentRound?.capacityPercentage < 100);
const nextOpenDate =
    nextOpenRound?.dates?.opens || currentRound?.dates?.opens || "soon";

// BREADCRUMBS
const breadcrumbs = [
    { name: "Awards", path: "/awards" },
    { name: pageTitle, path: `/awards/${slug}` },
];

// LAYOUT
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";

// COMPONENTS
import EligibleHero from "@components/awards/EligibleHero.astro";
import HowApplyingWorks from "@components/awards/HowApplyingWorks.astro";
import RoundWidget from "@components/awards/RoundWidgetWrapper.astro";
import FrequentlyAskedQuestions from "@components/awards/FrequentlyAskedQuestions.astro";
import ReadyToApplyCTA from "@components/awards/ReadyToApplyCTA.astro";
---

<Template name={pageTitle} description={pageDescription} noindex={true}>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
    </Container>
    <Container
        id="hero"
        class="bg-linear-to-br from-emerald-600 via-emerald-500 to-teal-500 text-white py-12 lg:py-16 mt-8"
    >
        <EligibleHero
            awards={awards}
            page={{
                tradingDescription:
                    application.trading_description ||
                    application.stage_text ||
                    "Your social venture qualifies",
            }}
            isRoundOpen={isRoundOpen}
            nextOpenDate={nextOpenDate}
            downloadUrl={`/awards/downloads/${slug}.pdf`}
            application={application}
        />
    </Container>
    <Container id="how-applying-works" class="bg-violet-950 py-16">
        <HowApplyingWorks showResourceLinks={true} />
    </Container>
    <Container id="when-to-apply" class="bg-violet-900 py-16 mt-8">
        <RoundWidget />
    </Container>
    <Container id="frequently-asked-questions" class="bg-violet-950 py-16 mt-8">
        <FrequentlyAskedQuestions />
    </Container>
    <Container id="apply" class="bg-violet-900 py-16 mt-8">
        <ReadyToApplyCTA
            isRoundOpen={isRoundOpen}
            nextOpenDate={nextOpenDate}
        />
    </Container>
</Template>
