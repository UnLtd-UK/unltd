---
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Default from "@components/heroes/Default.astro";
import Team from "@components/Team.astro";
import { people } from "@data/people.js";
import { teams } from "@data/teams.js";
import slugify from "slugify";

const name = "Our People";
const description =
  "Our people are passionate about breaking down the barriers faced by social entrepreneurs and delivering market leading support to grow their impact";

const breadcrumbs = [
  {
    name: "Our People",
    path: slugify(name, {
      lower: true,
      strict: true,
      locale: "en",
      trim: true,
    }),
  },
];

const parseSortValue = (value) => {
  if (typeof value === "number") return value;
  const numericValue = Number(value);
  return Number.isFinite(numericValue) ? numericValue : Number.MAX_SAFE_INTEGER;
};

const getTeamId = (team) => {
  if (!team) return null;
  if (typeof team === "string" || typeof team === "number") return `${team}`;
  if (typeof team === "object" && "id" in team && team.id) return `${team.id}`;
  return null;
};

const getRoleName = (role) => {
  if (!role) return "";
  if (typeof role === "string") return role;
  if (typeof role === "object") {
    if ("name" in role && role.name) return role.name;
    if ("title" in role && role.title) return role.title;
  }
  return "";
};

const peopleList = Array.isArray(people) ? people : [];
const teamList = Array.isArray(teams) ? teams : [];

const teamSections = teamList
  .slice()
  .sort((a, b) => {
    const sortA = parseSortValue(a?.sort);
    const sortB = parseSortValue(b?.sort);

    if (sortA !== sortB) {
      return sortA - sortB;
    }
    return 0;
  })
  .map((team) => {
    const teamId = getTeamId(team);
    const members = peopleList.filter((person) => {
      const personTeamId = getTeamId(person?.team);
      return Boolean(teamId && personTeamId && personTeamId === teamId);
    });

    const memberSet = new Set(members);

    if ((team?.name || "").toLowerCase() === "executive team") {
      const directorMembers = peopleList.filter((person) => {
        const roleName = getRoleName(person?.role).trim();
        return roleName.toLowerCase().startsWith("director of ");
      });

      directorMembers.forEach((person) => {
        if (!memberSet.has(person)) {
          memberSet.add(person);
          members.push(person);
        }
      });
    }

    return {
      team,
      members,
    };
  })
  .filter(({ team }) => Boolean(team?.name));
---

<Template name={name} description={description}>
  <Container>
    <Breadcrumbs breadcrumbs={breadcrumbs} />
    <Default name={name} description={description} />
    {
      teamSections.map(({ team, members }, index) => (
        <Team team={team} members={members} key={team?.id || index} />
      ))
    }
  </Container>
</Template>
