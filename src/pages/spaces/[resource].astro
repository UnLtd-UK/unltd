---
/**
 * Individual Resource Page - Canonical URL
 * Flat URL structure: /spaces/[resource-slug]
<<<<<<< HEAD
<<<<<<< HEAD
 *
 * Only generates pages for resources that belong to at least one PUBLIC space.
 * Resources that only belong to restricted spaces are not generated.
=======
 * Access control based on spaces the resource belongs to:
 * - If belongs to ANY public space → public access
 * - If only in restricted spaces → requires authentication
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
 *
 * Access control based on priority system:
 * When a resource belongs to multiple spaces, it inherits the
 * MOST PERMISSIVE (highest priority) access level:
 * - Priority 4: Public + Listed (no auth needed)
 * - Priority 3: Public + Unlisted (no auth needed)
 * - Priority 2: Restricted + Listed (auth required)
 * - Priority 1: Restricted + Unlisted (auth required)
 *
 * When auth is required, the password prompt lists ALL restricted
 * spaces the resource belongs to, and accepts any valid password.
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)
 */

import slugify from "slugify";
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Default from "@components/heroes/Default.astro";
import Content from "@components/markdoc/Content.astro";
import TableOfContents from "@components/TableOfContents.astro";
<<<<<<< HEAD
<<<<<<< HEAD
=======
import SpaceAuth from "@components/SpaceAuth.astro";
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
import ResourceAuth from "@components/ResourceAuth.astro";
>>>>>>> 8c3fa8c (feat: refactor resource components to use topic instead of category)

import { allSpaces } from "@data/spaces.js";
import { allResources } from "@data/resources.js";
import { prepareMarkdown } from "@data/functions/prepareMarkdown.ts";
import { prepareToc } from "@data/functions/prepareToc.ts";
<<<<<<< HEAD
<<<<<<< HEAD
import { getEffectiveAccess } from "@utils/spaceAccess";
=======
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
import { getEffectiveAccess, getRestrictedSpaces } from "@utils/spaceAccess";
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)

// Type definitions
interface Space {
    id: string;
    name: string;
    description: string;
<<<<<<< HEAD
<<<<<<< HEAD
    unlisted: boolean;
=======
    access: "public" | "unlisted" | "restricted";
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
    unlisted: boolean;
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)
    restricted_password?: string;
    eventbrite_keywords?: string[];
}

interface ResourceSpace {
    spaces_id?: { id: string; name: string };
}

interface Resource {
    id: string;
    name: string;
    description: string;
    body?: string;
    type: "guide" | "video" | "form" | "external";
<<<<<<< HEAD
<<<<<<< HEAD
    topic?: string;
=======
    category?: string;
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
    topic?: string;
>>>>>>> 8c3fa8c (feat: refactor resource components to use topic instead of category)
    external_url?: string;
    spaces?: ResourceSpace[];
}

interface TocHeading {
    id: string;
    level: number;
    text: string;
}

export async function getStaticPaths() {
    const paths: Array<{
        params: { resource: string };
        props: {
            resource: Resource;
            resourceSlug: string;
            body: string;
            toc: TocHeading[];
<<<<<<< HEAD
            isListed: boolean;
=======
            isPublic: boolean;
            isListed: boolean;
            restrictedSpaces: Space[];
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
        };
    }> = [];

    // Get all guide resources (those with body content)
    const guideResources = (allResources as Resource[]).filter(
        (resource) => resource.type === "guide" && resource.body,
    );

    for (const resource of guideResources) {
        const resourceSlug = slugify(resource.name, {
            lower: true,
            strict: true,
            locale: "en",
            trim: true,
        });

        const body = prepareMarkdown(resource.body || "");
        const toc = prepareToc(body);

        // Determine access based on spaces this resource belongs to
        const resourceSpaceIds = (resource.spaces || [])
            .map((s) => s.spaces_id?.id)
            .filter(Boolean);

        const resourceSpaces = (allSpaces as Space[]).filter((space) =>
            resourceSpaceIds.includes(space.id),
        );

<<<<<<< HEAD
<<<<<<< HEAD
        // Get effective access based on highest priority space
        const effectiveAccess = getEffectiveAccess(resourceSpaces);

        // Only generate pages for resources that have PUBLIC access
        // Skip resources that only belong to restricted spaces
        if (!effectiveAccess.isPublic) {
            continue;
        }

        const isListed = effectiveAccess.isListed;
=======
        // If belongs to ANY public space, it's public
        const isPublic = resourceSpaces.some(
            (space) => space.access === "public",
        );
=======
        // Get effective access based on highest priority space
        const effectiveAccess = getEffectiveAccess(resourceSpaces);
        const isPublic = effectiveAccess.isPublic;
        const isListed = effectiveAccess.isListed;
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)

        // Get ALL restricted spaces for auth prompt (user can use any valid password)
        const restrictedSpaces = isPublic
            ? []
<<<<<<< HEAD
            : resourceSpaces.filter((space) => space.access === "restricted");
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
            : getRestrictedSpaces(resourceSpaces);
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)

        paths.push({
            params: {
                resource: resourceSlug,
            },
            props: {
                resource,
                resourceSlug,
                body,
                toc,
<<<<<<< HEAD
                isListed,
=======
                isPublic,
                isListed,
                restrictedSpaces,
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
            },
        });
    }

    return paths;
}

<<<<<<< HEAD
<<<<<<< HEAD
const { resource, resourceSlug, body, toc, isListed } = Astro.props as {
=======
const {
    resource,
    resourceSlug,
    body,
    toc,
    isPublic,
    isListed,
    restrictedSpaces,
} = Astro.props as {
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)
    resource: Resource;
    resourceSlug: string;
    body: string;
    toc: TocHeading[];
<<<<<<< HEAD
    isListed: boolean;
};
=======
const { resource, resourceSlug, body, toc, isPublic, restrictedSpaces } =
    Astro.props as {
        resource: Resource;
        resourceSlug: string;
        body: string;
        toc: TocHeading[];
        isPublic: boolean;
        restrictedSpaces: Space[];
    };
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
    isPublic: boolean;
    isListed: boolean;
    restrictedSpaces: Space[];
};
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)

// Breadcrumbs
const breadcrumbs = [
    { name: "Spaces", path: "/spaces" },
    { name: resource.name, path: `/spaces/${resourceSlug}` },
];

<<<<<<< HEAD
<<<<<<< HEAD
// noindex if unlisted
const shouldNoindex = !isListed;
=======
// For restricted resources, use the first restricted space for auth
const authSpace = restrictedSpaces[0];
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
// Prepare restricted spaces data for auth component
const restrictedSpacesData = restrictedSpaces.map((space) => ({
    slug: slugify(space.name, {
        lower: true,
        strict: true,
        locale: "en",
        trim: true,
    }),
    name: space.name,
    password: space.restricted_password || "",
}));
<<<<<<< HEAD
>>>>>>> 8c3fa8c (feat: refactor resource components to use topic instead of category)
=======

// noindex if restricted OR if effective access is unlisted
const shouldNoindex = !isPublic || !isListed;
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)
---

<Template
    name={resource.name}
    description={resource.description}
<<<<<<< HEAD
<<<<<<< HEAD
    noindex={shouldNoindex}
>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
        <div class="mt-8">
            <Default name={resource.name} description={resource.description} />
        </div>
=======
    noindex={!isPublic}
=======
    noindex={shouldNoindex}
>>>>>>> 190cfff (feat: implement priority-based access control for spaces and resources)
>
    {
        /* Password protection for restricted resources - accepts any valid password */
    }
    {
        !isPublic && restrictedSpacesData.length > 0 && (
            <ResourceAuth
                restrictedSpaces={restrictedSpacesData}
                resourceName={resource.name}
            />
        )
    }

    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
<<<<<<< HEAD
        <Default name={resource.name} description={resource.description} />
>>>>>>> 9d79ac1 (Refactor resource and space pages to improve URL structure and access control)
=======
        <div class="mt-8">
            <Default name={resource.name} description={resource.description} />
        </div>
>>>>>>> 8c3fa8c (feat: refactor resource components to use topic instead of category)

        <div class="flex gap-8 lg:gap-12 pb-16 items-start">
            {/* Table of Contents - Desktop Sidebar */}
            <aside class="hidden lg:block sticky top-24">
                <TableOfContents headings={toc} variant="desktop" />
            </aside>

            {/* Main Content */}
            <article class="flex-1 min-w-0">
                <div
                    class="bg-violet-900/30 rounded-2xl ring-1 ring-violet-700/50 p-6 sm:p-8 lg:p-10"
                >
                    <Content body={body} />
                </div>
            </article>
        </div>
    </Container>

    {/* Mobile Table of Contents */}
    <TableOfContents headings={toc} variant="mobile" />
</Template>
