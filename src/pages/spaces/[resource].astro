---
/**
 * Individual Resource Page - Canonical URL
 * Flat URL structure: /spaces/[resource-slug]
 *
 * Only generates pages for resources that belong to at least one PUBLIC space.
 * Resources that only belong to restricted spaces are not generated.
 */

import slugify from "slugify";
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Default from "@components/heroes/Default.astro";
import Content from "@components/markdoc/Content.astro";
import TableOfContents from "@components/TableOfContents.astro";

import { allSpaces } from "@data/spaces.js";
import { allResources } from "@data/resources.js";
import { prepareMarkdown } from "@data/functions/prepareMarkdown.ts";
import { prepareToc } from "@data/functions/prepareToc.ts";
import { getEffectiveAccess } from "@utils/spaceAccess";

// Type definitions
interface Space {
    id: string;
    name: string;
    description: string;
    unlisted: boolean;
    restricted_password?: string;
    eventbrite_keywords?: string[];
}

interface ResourceSpace {
    spaces_id?: { id: string; name: string };
}

interface Resource {
    id: string;
    name: string;
    description: string;
    body?: string;
    type: "guide" | "video" | "form" | "external";
    topic?: string;
    external_url?: string;
    date_updated?: string;
    spaces?: ResourceSpace[];
}

interface TocHeading {
    id: string;
    level: number;
    text: string;
}

export async function getStaticPaths() {
    const paths: Array<{
        params: { resource: string };
        props: {
            resource: Resource;
            resourceSlug: string;
            body: string;
            toc: TocHeading[];
            isListed: boolean;
        };
    }> = [];

    // Get all guide resources (those with body content)
    const guideResources = (allResources as Resource[]).filter(
        (resource) => resource.type === "guide" && resource.body,
    );

    for (const resource of guideResources) {
        const resourceSlug = slugify(resource.name, {
            lower: true,
            strict: true,
            locale: "en",
            trim: true,
        });

        const body = prepareMarkdown(resource.body || "");
        const toc = prepareToc(body);

        // Determine access based on spaces this resource belongs to
        const resourceSpaceIds = (resource.spaces || [])
            .map((s) => s.spaces_id?.id)
            .filter(Boolean);

        const resourceSpaces = (allSpaces as Space[]).filter((space) =>
            resourceSpaceIds.includes(space.id),
        );

        // Get effective access based on highest priority space
        const effectiveAccess = getEffectiveAccess(resourceSpaces);

        // Only generate pages for resources that have PUBLIC access
        // Skip resources that only belong to restricted spaces
        if (!effectiveAccess.isPublic) {
            continue;
        }

        const isListed = effectiveAccess.isListed;

        paths.push({
            params: {
                resource: resourceSlug,
            },
            props: {
                resource,
                resourceSlug,
                body,
                toc,
                isListed,
            },
        });
    }

    return paths;
}

const { resource, resourceSlug, body, toc, isListed } = Astro.props as {
    resource: Resource;
    resourceSlug: string;
    body: string;
    toc: TocHeading[];
    isListed: boolean;
};

// Breadcrumbs
const breadcrumbs = [
    { name: "Spaces", path: "/spaces" },
    { name: resource.name, path: `/spaces/${resourceSlug}` },
];

// noindex if unlisted
const shouldNoindex = !isListed;

// Calculate reading time (average 200 words per minute)
const wordCount = body.trim().split(/\s+/).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Format last updated date
const lastUpdated = resource.date_updated
    ? new Date(resource.date_updated).toLocaleDateString("en-GB", {
          day: "numeric",
          month: "short",
          year: "numeric",
      })
    : null;
---

<Template
    name={resource.name}
    description={resource.description}
    noindex={shouldNoindex}
>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
        <div class="mt-8">
            <Default name={resource.name} description={resource.description} />
        </div>

        {/* Resource stats */}
        <div
            class="flex flex-wrap items-center gap-4 text-sm text-violet-300 mb-8"
        >
            <div class="flex items-center gap-1.5">
                <svg
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                    ></path>
                </svg>
                <span>{readingTime} min read</span>
            </div>
            {
                lastUpdated && (
                    <div class="flex items-center gap-1.5">
                        <svg
                            class="h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1.5"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
                            />
                        </svg>
                        <span>Updated {lastUpdated}</span>
                    </div>
                )
            }
            <button
                id="share-button"
                class="flex items-center gap-1.5 hover:text-white transition-colors cursor-pointer"
                aria-label="Copy link to clipboard"
            >
                <svg
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"
                    ></path>
                </svg>
                <span id="share-text">Share</span>
            </button>
        </div>

        <script is:inline>
            document
                .getElementById("share-button")
                .addEventListener("click", function () {
                    const shareText = document.getElementById("share-text");
                    navigator.clipboard
                        .writeText(window.location.href)
                        .then(function () {
                            shareText.textContent = "Copied!";
                            setTimeout(function () {
                                shareText.textContent = "Share";
                            }, 2000);
                        });
                });
        </script>

        <div class="flex gap-8 lg:gap-12 pb-16 items-start">
            {/* Table of Contents - Desktop Sidebar */}
            <aside class="hidden lg:block sticky top-24">
                <TableOfContents headings={toc} variant="desktop" />
            </aside>

            {/* Main Content */}
            <article class="flex-1 min-w-0">
                <div
                    class="bg-violet-900/30 rounded-2xl ring-1 ring-violet-700/50 p-6 sm:p-8 lg:p-10"
                >
                    <Content body={body} />
                </div>
            </article>
        </div>
    </Container>
</Template>
