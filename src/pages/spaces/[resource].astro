---
/**
 * Individual Resource Page - Canonical URL
 * Flat URL structure: /spaces/[resource-slug]
 *
 * Only generates pages for resources that belong to at least one PUBLIC space.
 * Resources that only belong to restricted spaces are not generated.
 */

import slugify from "slugify";
import Template from "@layouts/Template.astro";
import Container from "@components/Container.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Default from "@components/heroes/Default.astro";
import Content from "@components/markdoc/Content.astro";
import TableOfContents from "@components/TableOfContents.astro";

import { allSpaces } from "@data/spaces.js";
import { allResources } from "@data/resources.js";
import { prepareMarkdown } from "@data/functions/prepareMarkdown.ts";
import { prepareToc } from "@data/functions/prepareToc.ts";
import { getEffectiveAccess } from "@utils/spaceAccess";

// Type definitions
interface Space {
    id: string;
    name: string;
    description: string;
    unlisted: boolean;
    restricted_password?: string;
    eventbrite_keywords?: string[];
}

interface ResourceSpace {
    spaces_id?: { id: string; name: string };
}

interface Resource {
    id: string;
    name: string;
    description: string;
    body?: string;
    type: "guide" | "video" | "form" | "external";
    topic?: string;
    external_url?: string;
    spaces?: ResourceSpace[];
}

interface TocHeading {
    id: string;
    level: number;
    text: string;
}

export async function getStaticPaths() {
    const paths: Array<{
        params: { resource: string };
        props: {
            resource: Resource;
            resourceSlug: string;
            body: string;
            toc: TocHeading[];
            isListed: boolean;
        };
    }> = [];

    // Get all guide resources (those with body content)
    const guideResources = (allResources as Resource[]).filter(
        (resource) => resource.type === "guide" && resource.body,
    );

    for (const resource of guideResources) {
        const resourceSlug = slugify(resource.name, {
            lower: true,
            strict: true,
            locale: "en",
            trim: true,
        });

        const body = prepareMarkdown(resource.body || "");
        const toc = prepareToc(body);

        // Determine access based on spaces this resource belongs to
        const resourceSpaceIds = (resource.spaces || [])
            .map((s) => s.spaces_id?.id)
            .filter(Boolean);

        const resourceSpaces = (allSpaces as Space[]).filter((space) =>
            resourceSpaceIds.includes(space.id),
        );

        // Get effective access based on highest priority space
        const effectiveAccess = getEffectiveAccess(resourceSpaces);
        
        // Only generate pages for resources that have PUBLIC access
        // Skip resources that only belong to restricted spaces
        if (!effectiveAccess.isPublic) {
            continue;
        }

        const isListed = effectiveAccess.isListed;

        paths.push({
            params: {
                resource: resourceSlug,
            },
            props: {
                resource,
                resourceSlug,
                body,
                toc,
                isListed,
            },
        });
    }

    return paths;
}

const {
    resource,
    resourceSlug,
    body,
    toc,
    isListed,
} = Astro.props as {
    resource: Resource;
    resourceSlug: string;
    body: string;
    toc: TocHeading[];
    isListed: boolean;
};

// Breadcrumbs
const breadcrumbs = [
    { name: "Spaces", path: "/spaces" },
    { name: resource.name, path: `/spaces/${resourceSlug}` },
];

// noindex if unlisted
const shouldNoindex = !isListed;
---

<Template
    name={resource.name}
    description={resource.description}
    noindex={shouldNoindex}
>
    <Container>
        <Breadcrumbs breadcrumbs={breadcrumbs} />
        <div class="mt-8">
            <Default name={resource.name} description={resource.description} />
        </div>

        <div class="flex gap-8 lg:gap-12 pb-16 items-start">
            {/* Table of Contents - Desktop Sidebar */}
            <aside class="hidden lg:block sticky top-24">
                <TableOfContents headings={toc} variant="desktop" />
            </aside>

            {/* Main Content */}
            <article class="flex-1 min-w-0">
                <div
                    class="bg-violet-900/30 rounded-2xl ring-1 ring-violet-700/50 p-6 sm:p-8 lg:p-10"
                >
                    <Content body={body} />
                </div>
            </article>
        </div>
    </Container>

    {/* Mobile Table of Contents */}
    <TableOfContents headings={toc} variant="mobile" />
</Template>
