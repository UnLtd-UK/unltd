name: Deploy Preview

on:
    push:
        branches:
            - dev
    workflow_dispatch:
    schedule:
        # 09:00 UTC daily - builds dev and deploys to preview
        - cron: "0 9 * * *"

jobs:
    deploy-preview:
        name: Deploy preview.unltd.org.uk
        runs-on: ubuntu-latest
        env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
            EVENTBRITE_PRIVATE_TOKEN: ${{ secrets.EVENTBRITE_PRIVATE_TOKEN }}
            FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
            BRANCH_NAME: dev
            DEPLOY_ENVIRONMENT: preview
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
              with:
                  ref: dev

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Setup FontAwesome NPM registry
              run: ./scripts/setup-npmrc.sh

            - name: Install dependencies
              run: npm ci

            - name: Build site
              run: npm run build

            - name: Deploy preview worker
              run: npx wrangler deploy --env preview
